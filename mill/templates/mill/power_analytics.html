{% extends 'mill/base.html' %}
{% load static %}

{% block title %}Power Analytics{% endblock %}

{% block content %}
<style>
    .power-analytics-page {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .page-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .page-title {
        color: white;
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .page-subtitle {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.1rem;
    }
    
    .analytics-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 30px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .stat-card.critical {
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
    }
    
    .stat-card.critical .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #ffa726, #ff9800);
        color: white;
    }
    
    .stat-card.warning .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #66bb6a, #4caf50);
        color: white;
    }
    
    .stat-card.success .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #29b6f6, #0288d1);
        color: white;
    }
    
    .stat-card.info .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .trends-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        margin-bottom: 30px;
    }
    
    .trend-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
    }
    
    .trend-item:hover {
        background-color: #f8f9fa;
    }
    
    .trend-item:last-child {
        border-bottom: none;
    }
    
    .trend-label {
        font-weight: 600;
        color: #333;
    }
    
    .trend-value {
        font-weight: bold;
        color: #333;
    }
    
    .trend-change {
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 15px;
        font-weight: 600;
    }
    
    .trend-change.positive {
        background: #d4edda;
        color: #155724;
    }
    
    .trend-change.negative {
        background: #f8d7da;
        color: #721c24;
    }
    
    .trend-change.neutral {
        background: #e2e3e5;
        color: #383d41;
    }
    
    .btn-modern {
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .btn-primary-modern {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }
    
    .btn-primary-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-success-modern {
        background: linear-gradient(135deg, #66bb6a, #4caf50);
        color: white;
    }
    
    .btn-success-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 187, 106, 0.4);
        color: white;
    }
    
    .efficiency-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .efficiency-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    
    .efficiency-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }
    
    .efficiency-value {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
    }
    
    .efficiency-description {
        color: #666;
        font-size: 0.9rem;
    }
    
    .power-consumption-chart {
        height: 400px;
        margin-top: 20px;
    }
</style>

<div class="power-analytics-page">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-graph-up me-3"></i>
            Power Analytics
        </h1>
        <p class="page-subtitle">
            Comprehensive analysis of power consumption, efficiency, and trends
        </p>
    </div>

    <!-- Summary Statistics -->
    <div class="analytics-container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-bar-chart me-2"></i>
                Summary Statistics
            </h2>
            <div>
                <a href="{% url 'power_dashboard' %}" class="btn-modern btn-primary-modern">
                    <i class="bi bi-dashboard"></i>
                    Dashboard
                </a>
                <a href="{% url 'power_events_list' %}" class="btn-modern btn-success-modern">
                    <i class="bi bi-list"></i>
                    Events List
                </a>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card {% if summary.critical_events > 0 %}critical{% elif summary.unresolved_events > 0 %}warning{% else %}success{% endif %}">
                <div class="stat-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <div class="stat-number">{{ summary.unresolved_events }}</div>
                <div class="stat-label">Active Events</div>
            </div>
            
            <div class="stat-card {% if summary.critical_events > 0 %}critical{% else %}success{% endif %}">
                <div class="stat-icon">
                    <i class="bi bi-shield-exclamation"></i>
                </div>
                <div class="stat-number">{{ summary.critical_events }}</div>
                <div class="stat-label">Critical Events</div>
            </div>
            
            <div class="stat-card {% if devices_with_issues > 0 %}warning{% else %}success{% endif %}">
                <div class="stat-icon">
                    <i class="bi bi-power"></i>
                </div>
                <div class="stat-number">{{ devices_with_issues }}</div>
                <div class="stat-label">Devices Without Power</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-number">{{ summary.total_events }}</div>
                <div class="stat-label">Total Events Tracked</div>
            </div>
            
            <div class="stat-card info">
                <div class="stat-icon">
                    <i class="bi bi-calendar-event"></i>
                </div>
                <div class="stat-number">{{ recent_events }}</div>
                <div class="stat-label">Events (Last 30 Days)</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="bi bi-percent"></i>
                </div>
                <div class="stat-number">{{ uptime_percentage|floatformat:1 }}%</div>
                <div class="stat-label">System Uptime</div>
            </div>
        </div>
    </div>

    <!-- Power Efficiency Metrics -->
    <div class="analytics-container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-speedometer2 me-2"></i>
                Power Efficiency Metrics
            </h2>
        </div>

        <div class="efficiency-metrics">
            <div class="efficiency-card">
                <div class="efficiency-title">Average Power Consumption</div>
                <div class="efficiency-value">{{ avg_power_consumption|floatformat:2 }} kW</div>
                <div class="efficiency-description">Average power consumption across all devices</div>
            </div>
            
            <div class="efficiency-card">
                <div class="efficiency-title">Peak Power Usage</div>
                <div class="efficiency-value">{{ peak_power_usage|floatformat:2 }} kW</div>
                <div class="efficiency-description">Highest recorded power consumption</div>
            </div>
            
            <div class="efficiency-card">
                <div class="efficiency-title">Power Efficiency Score</div>
                <div class="efficiency-value">{{ power_efficiency_score|floatformat:1 }}/100</div>
                <div class="efficiency-description">Overall power efficiency rating</div>
            </div>
            
            <div class="efficiency-card">
                <div class="efficiency-title">Energy Cost Savings</div>
                <div class="efficiency-value">€{{ energy_cost_savings|floatformat:2 }}</div>
                <div class="efficiency-description">Estimated monthly energy cost savings</div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="analytics-container">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-graph-up me-2"></i>
                Power Consumption Trends
            </h2>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="bi bi-lightning-charge"></i>
                    Power Consumption Over Time
                </h3>
                <div class="chart-container">
                    <canvas id="powerConsumptionChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="bi bi-pie-chart"></i>
                    Events by Type
                </h3>
                <div class="chart-container">
                    <canvas id="eventsByTypeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="bi bi-bar-chart"></i>
                    Events by Severity
                </h3>
                <div class="chart-container">
                    <canvas id="eventsBySeverityChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">
                    <i class="bi bi-activity"></i>
                    Power Efficiency Trends
                </h3>
                <div class="chart-container">
                    <canvas id="efficiencyTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Trends Analysis -->
    <div class="trends-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-trending-up me-2"></i>
                Trends Analysis
            </h2>
        </div>

        <div class="trend-item">
            <div class="trend-label">Power Events Trend</div>
            <div class="trend-value">{{ events_trend_count }}</div>
            <div class="trend-change {% if events_trend_direction == 'up' %}negative{% elif events_trend_direction == 'down' %}positive{% else %}neutral{% endif %}">
                {% if events_trend_direction == 'up' %}
                    <i class="bi bi-arrow-up"></i> {{ events_trend_percentage|floatformat:1 }}%
                {% elif events_trend_direction == 'down' %}
                    <i class="bi bi-arrow-down"></i> {{ events_trend_percentage|floatformat:1 }}%
                {% else %}
                    <i class="bi bi-dash"></i> No change
                {% endif %}
            </div>
        </div>

        <div class="trend-item">
            <div class="trend-label">Power Consumption Trend</div>
            <div class="trend-value">{{ consumption_trend_value|floatformat:2 }} kW</div>
            <div class="trend-change {% if consumption_trend_direction == 'up' %}negative{% elif consumption_trend_direction == 'down' %}positive{% else %}neutral{% endif %}">
                {% if consumption_trend_direction == 'up' %}
                    <i class="bi bi-arrow-up"></i> {{ consumption_trend_percentage|floatformat:1 }}%
                {% elif consumption_trend_direction == 'down' %}
                    <i class="bi bi-arrow-down"></i> {{ consumption_trend_percentage|floatformat:1 }}%
                {% else %}
                    <i class="bi bi-dash"></i> No change
                {% endif %}
            </div>
        </div>

        <div class="trend-item">
            <div class="trend-label">System Uptime Trend</div>
            <div class="trend-value">{{ uptime_trend_value|floatformat:1 }}%</div>
            <div class="trend-change {% if uptime_trend_direction == 'up' %}positive{% elif uptime_trend_direction == 'down' %}negative{% else %}neutral{% endif %}">
                {% if uptime_trend_direction == 'up' %}
                    <i class="bi bi-arrow-up"></i> {{ uptime_trend_percentage|floatformat:1 }}%
                {% elif uptime_trend_direction == 'down' %}
                    <i class="bi bi-arrow-down"></i> {{ uptime_trend_percentage|floatformat:1 }}%
                {% else %}
                    <i class="bi bi-dash"></i> No change
                {% endif %}
            </div>
        </div>

        <div class="trend-item">
            <div class="trend-label">Energy Efficiency Trend</div>
            <div class="trend-value">{{ efficiency_trend_value|floatformat:1 }}/100</div>
            <div class="trend-change {% if efficiency_trend_direction == 'up' %}positive{% elif efficiency_trend_direction == 'down' %}negative{% else %}neutral{% endif %}">
                {% if efficiency_trend_direction == 'up' %}
                    <i class="bi bi-arrow-up"></i> {{ efficiency_trend_percentage|floatformat:1 }}%
                {% elif efficiency_trend_direction == 'down' %}
                    <i class="bi bi-arrow-down"></i> {{ efficiency_trend_percentage|floatformat:1 }}%
                {% else %}
                    <i class="bi bi-dash"></i> No change
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Power Consumption Chart
const powerCtx = document.getElementById('powerConsumptionChart').getContext('2d');
const powerChart = new Chart(powerCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Power Consumption (kW)',
            data: [12.5, 13.2, 11.8, 14.1, 12.9, 13.5],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Power (kW)'
                }
            }
        }
    }
});

// Events by Type Chart
const eventsTypeCtx = document.getElementById('eventsByTypeChart').getContext('2d');
const eventsTypeChart = new Chart(eventsTypeCtx, {
    type: 'doughnut',
    data: {
        labels: ['Power Loss', 'Power Restored', 'Production Without Power', 'Power Fluctuation'],
        datasets: [{
            data: [{{ events_by_type.power_loss|default:0 }}, {{ events_by_type.power_restored|default:0 }}, {{ events_by_type.production_without_power|default:0 }}, {{ events_by_type.power_fluctuation|default:0 }}],
            backgroundColor: [
                '#dc3545',
                '#28a745',
                '#ffc107',
                '#17a2b8'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Events by Severity Chart
const eventsSeverityCtx = document.getElementById('eventsBySeverityChart').getContext('2d');
const eventsSeverityChart = new Chart(eventsSeverityCtx, {
    type: 'bar',
    data: {
        labels: ['Low', 'Medium', 'High', 'Critical'],
        datasets: [{
            label: 'Number of Events',
            data: [{{ events_by_severity.low|default:0 }}, {{ events_by_severity.medium|default:0 }}, {{ events_by_severity.high|default:0 }}, {{ events_by_severity.critical|default:0 }}],
            backgroundColor: [
                '#17a2b8',
                '#ffc107',
                '#fd7e14',
                '#dc3545'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Number of Events'
                }
            }
        }
    }
});

// Efficiency Trends Chart
const efficiencyCtx = document.getElementById('efficiencyTrendsChart').getContext('2d');
const efficiencyChart = new Chart(efficiencyCtx, {
    type: 'line',
    data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Efficiency Score',
            data: [85, 87, 89, 88, 91, 93],
            borderColor: '#66bb6a',
            backgroundColor: 'rgba(102, 187, 106, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                title: {
                    display: true,
                    text: 'Efficiency Score'
                }
            }
        }
    }
});

// Auto-refresh every 5 minutes
setInterval(function() {
    location.reload();
}, 300000);
</script>
{% endblock %} 
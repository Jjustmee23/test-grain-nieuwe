{% extends 'mill/base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Device Power Analyse - {{ device.name }}{% endblock %}

{% block content %}
<style>
    .device-analysis {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .device-header {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    .status-power-loss { background: #ffc107; }
    .status-unknown { background: #6c757d; }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-card.critical {
        border-left: 4px solid #dc3545;
    }
    
    .stat-card.warning {
        border-left: 4px solid #ffc107;
    }
    
    .stat-card.info {
        border-left: 4px solid #17a2b8;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }
    
    .incidents-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .incident-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }
    
    .incident-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .incident-header.critical {
        background: #fff5f5;
        border-left: 4px solid #dc3545;
    }
    
    .incident-header.warning {
        background: #fffbf0;
        border-left: 4px solid #ffc107;
    }
    
    .incident-details {
        padding: 15px;
    }
    
    .incident-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 10px;
    }
    
    .incident-stat {
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    
    .incident-stat.critical {
        background: #fff5f5;
        color: #dc3545;
    }
    
    .no-data {
        text-align: center;
        padding: 50px;
        color: #666;
    }
    
    .no-data i {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 20px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .btn-modern {
        padding: 10px 20px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary-modern {
        background: #007bff;
        color: white;
    }
    
    .btn-secondary-modern {
        background: #6c757d;
        color: white;
    }
    
    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white;
        text-decoration: none;
    }
</style>

<div class="device-analysis">
    <!-- Device Header -->
    <div class="device-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <span class="status-indicator status-{{ analysis.current_status }}"></span>
                    {{ device.name }}
                </h1>
                <p class="text-muted mb-0">
                    Device ID: {{ device.id }} | 
                    Factory: {% if device.factory %}{{ device.factory.name }}{% else %}Geen factory{% endif %}
                </p>
            </div>
            <div class="text-end">
                <h4 class="mb-1">
                    {% if analysis.current_status == 'online' %}
                        <span class="text-success">ONLINE</span>
                    {% elif analysis.current_status == 'offline' %}
                        <span class="text-danger">OFFLINE</span>
                    {% elif analysis.current_status == 'power_loss' %}
                        <span class="text-warning">POWER LOSS</span>
                    {% else %}
                        <span class="text-muted">UNKNOWN</span>
                    {% endif %}
                </h4>
                {% if power_status %}
                    <small class="text-muted">
                        Laatste update: {{ power_status.last_updated|date:"d/m/Y H:i" }}
                    </small>
                {% endif %}
            </div>
        </div>
    </div>

    {% if analysis.has_data %}
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card {% if analysis.statistics.incidents_with_counter > 0 %}critical{% else %}info{% endif %}">
                <div class="stat-value">{{ analysis.statistics.total_incidents }}</div>
                <div class="stat-label">Total Incidenten</div>
            </div>
            <div class="stat-card {% if analysis.statistics.incidents_with_counter > 0 %}critical{% else %}warning{% endif %}">
                <div class="stat-value">{{ analysis.statistics.incidents_with_counter }}</div>
                <div class="stat-label">Met Counter Activiteit</div>
            </div>
            <div class="stat-card {% if analysis.statistics.total_production_without_power > 0 %}critical{% else %}info{% endif %}">
                <div class="stat-value">{{ analysis.statistics.total_production_without_power }}</div>
                <div class="stat-label">Productie Zonder Stroom</div>
            </div>
            <div class="stat-card info">
                <div class="stat-value">
                    {% if analysis.statistics.total_downtime.days > 0 %}
                        {{ analysis.statistics.total_downtime.days }}d
                    {% else %}
                        {{ analysis.statistics.total_downtime.seconds|floatformat:0|div:3600|floatformat:1 }}h
                    {% endif %}
                </div>
                <div class="stat-label">Total Downtime</div>
            </div>
        </div>

        <!-- Power Outages with Production Section -->
        {% if analysis.power_outages_with_production %}
        <div class="incidents-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="bi bi-lightning-charge"></i> Power Onderbrekingen met Productie</h3>
                <a href="{% url 'export_power_outages' device.id %}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Export naar Excel
                </a>
            </div>
            
            <!-- Simple Overview -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Overzicht Power Onderbrekingen</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-primary">{{ analysis.power_outages_with_production|length }}</h4>
                                        <small class="text-muted">Totaal Onderbrekingen</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-danger">
                                            {% for outage in analysis.power_outages_with_production %}
                                                {% if forloop.first %}
                                                    {% with total=outage.total_production %}
                                                        {% for outage2 in analysis.power_outages_with_production %}
                                                            {% if not forloop.first %}
                                                                {% with total=total|add:outage2.total_production %}{% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {{ total }}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                        </h4>
                                        <small class="text-muted">Totaal Productie zonder Stroom</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-warning">
                                            {% for outage in analysis.power_outages_with_production %}
                                                {% if forloop.first %}
                                                    {% with total=outage.duration %}
                                                        {% for outage2 in analysis.power_outages_with_production %}
                                                            {% if not forloop.first %}
                                                                {% with total=total|add:outage2.duration %}{% endwith %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% if total.days > 0 %}
                                                            {{ total.days }}d
                                                        {% else %}
                                                            {{ total.seconds|floatformat:0|div:3600|floatformat:1 }}h
                                                        {% endif %}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                        </h4>
                                        <small class="text-muted">Totaal Duur</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <h4 class="text-info">
                                            {% for outage in analysis.power_outages_with_production %}
                                                {% if outage.is_ongoing %}
                                                    <span class="badge bg-warning">ONGOING</span>
                                                {% endif %}
                                            {% endfor %}
                                        </h4>
                                        <small class="text-muted">Status</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Cards for each outage -->
            {% for outage in analysis.power_outages_with_production %}
            <div class="outage-item mb-4">
                <div class="card">
                    <div class="card-header {% if outage.total_production > 0 %}bg-danger text-white{% else %}bg-warning{% endif %}">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-0">
                                    {% if outage.type == 'multiple' %}
                                        <i class="bi bi-calendar-range"></i> 
                                        {{ outage.date_range }} ({{ outage.outage_count }} onderbrekingen)
                                    {% else %}
                                        <i class="bi bi-calendar"></i> 
                                        {{ outage.date_range }}
                                    {% endif %}
                                    {% if outage.is_ongoing %}
                                        <span class="badge bg-warning ms-2">ONGOING</span>
                                    {% endif %}
                                </h5>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-light text-dark">
                                    {% if outage.duration.days > 0 %}
                                        {{ outage.duration.days }}d 
                                    {% endif %}
                                    {% if outage.duration.seconds > 3600 %}
                                        {{ outage.duration.seconds|floatformat:0|add:"-3600"|floatformat:0|div:3600|floatformat:0 }}h
                                    {% elif outage.duration.seconds > 60 %}
                                        {{ outage.duration.seconds|floatformat:0|div:60|floatformat:0 }}m
                                    {% else %}
                                        {{ outage.duration.seconds }}s
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Counter Details:</strong><br>
                                <small class="text-muted">
                                    Start: {{ outage.start_counter }} stuks<br>
                                    Eind: {{ outage.end_counter|default:"N/A" }} stuks<br>
                                    {% if outage.total_production > 0 %}
                                        <span class="text-danger fw-bold">
                                            Productie zonder stroom: {{ outage.total_production }} stuks
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Geen productie tijdens onderbreking</span>
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-md-6">
                                <strong>Tijdsperiode:</strong><br>
                                <small class="text-muted">
                                    <strong>{{ outage.time_range }}</strong><br>
                                    {% if outage.type == 'multiple' %}
                                        <span class="text-info">
                                            <i class="bi bi-info-circle"></i> 
                                            {{ outage.outage_count }} afzonderlijke onderbrekingen gecombineerd
                                        </span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        
                        {% if outage.production_events %}
                        <div class="mt-3">
                            <h6><i class="bi bi-clock-history"></i> Productie Events met Tijdstippen:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Tijdstip</th>
                                            <th>Tijd vanaf Start</th>
                                            <th>Counter Waarde</th>
                                            <th>Productie Increment</th>
                                            <th>Cumulatief</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in outage.production_events|slice:":5" %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ event.timestamp|date:"d/m/Y H:i:s" }}</td>
                                            <td>
                                                {% if event.time_from_start.days > 0 %}
                                                    {{ event.time_from_start.days }}d 
                                                {% endif %}
                                                {% if event.time_from_start.seconds > 3600 %}
                                                    {{ event.time_from_start.seconds|floatformat:0|add:"-3600"|floatformat:0|div:3600|floatformat:0 }}h
                                                {% elif event.time_from_start.seconds > 60 %}
                                                    {{ event.time_from_start.seconds|floatformat:0|div:60|floatformat:0 }}m
                                                {% else %}
                                                    {{ event.time_from_start.seconds }}s
                                                {% endif %}
                                            </td>
                                            <td>{{ event.counter_value }} stuks</td>
                                            <td class="text-success">+{{ event.production_increment }} stuks</td>
                                            <td class="text-danger fw-bold">{{ event.cumulative|default:event.production_increment }} stuks</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                {% if outage.production_events|length > 5 %}
                                    <div class="text-center mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#productionEventsModal{{ forloop.counter }}">
                                            <i class="bi bi-eye"></i> {{ outage.production_events|length|add:"-5" }} meer rijen bekijken
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if outage.type == 'multiple' and outage.individual_outages %}
                        <div class="mt-3">
                            <h6><i class="bi bi-list-ul"></i> Individuele Onderbrekingen:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Start</th>
                                            <th>Eind</th>
                                            <th>Duur</th>
                                            <th>Productie</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for individual in outage.individual_outages %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ individual.start_time|date:"d/m/Y H:i" }}</td>
                                            <td>{{ individual.end_time|date:"d/m/Y H:i"|default:"ONGOING" }}</td>
                                            <td>
                                                {% if individual.duration.days > 0 %}
                                                    {{ individual.duration.days }}d 
                                                {% endif %}
                                                {% if individual.duration.seconds > 3600 %}
                                                    {{ individual.duration.seconds|floatformat:0|add:"-3600"|floatformat:0|div:3600|floatformat:0 }}h
                                                {% elif individual.duration.seconds > 60 %}
                                                    {{ individual.duration.seconds|floatformat:0|div:60|floatformat:0 }}m
                                                {% else %}
                                                    {{ individual.duration.seconds }}s
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if individual.total_production > 0 %}
                                                    <span class="text-danger fw-bold">{{ individual.total_production }} stuks</span>
                                                {% else %}
                                                    <span class="text-muted">0 stuks</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Production Events Modals -->
        {% if analysis.power_outages_with_production %}
            {% for outage in analysis.power_outages_with_production %}
                {% if outage.production_events and outage.production_events|length > 5 %}
                <div class="modal fade" id="productionEventsModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="productionEventsModalLabel{{ forloop.counter }}" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="productionEventsModalLabel{{ forloop.counter }}">
                                    <i class="bi bi-clock-history"></i> Alle Productie Events - {{ outage.date_range }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Counter Details:</strong><br>
                                        <small class="text-muted">
                                            Start: {{ outage.start_counter }} stuks<br>
                                            Eind: {{ outage.end_counter|default:"N/A" }} stuks<br>
                                            <span class="text-danger fw-bold">
                                                Totaal Productie zonder stroom: {{ outage.total_production }} stuks
                                            </span>
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Tijdsperiode:</strong><br>
                                        <small class="text-muted">
                                            <strong>{{ outage.time_range }}</strong>
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>Tijdstip</th>
                                                <th>Tijd vanaf Start</th>
                                                <th>Counter Waarde</th>
                                                <th>Productie Increment</th>
                                                <th>Cumulatief</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for event in outage.production_events %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ event.timestamp|date:"d/m/Y H:i:s" }}</td>
                                                <td>
                                                    {% if event.time_from_start.days > 0 %}
                                                        {{ event.time_from_start.days }}d 
                                                    {% endif %}
                                                    {% if event.time_from_start.seconds > 3600 %}
                                                        {{ event.time_from_start.seconds|floatformat:0|add:"-3600"|floatformat:0|div:3600|floatformat:0 }}h
                                                    {% elif event.time_from_start.seconds > 60 %}
                                                        {{ event.time_from_start.seconds|floatformat:0|div:60|floatformat:0 }}m
                                                    {% else %}
                                                        {{ event.time_from_start.seconds }}s
                                                    {% endif %}
                                                </td>
                                                <td>{{ event.counter_value }} stuks</td>
                                                <td class="text-success">+{{ event.production_increment }} stuks</td>
                                                <td class="text-danger fw-bold">{{ event.cumulative|default:event.production_increment }} stuks</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-dark">
                                            <tr>
                                                <td colspan="5"><strong>TOTAAL</strong></td>
                                                <td><strong class="text-danger">{{ outage.total_production }} stuks</strong></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
                                <a href="{% url 'export_power_outages' device.id %}" class="btn btn-success">
                                    <i class="bi bi-file-earmark-excel"></i> Export naar Excel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}





        <!-- Recent Power Events -->
        {% if analysis.recent_events %}
        <div class="incidents-section">
            <h3><i class="bi bi-list-ul"></i> Recente Power Events</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Datum/Tijd</th>
                            <th>Event Type</th>
                            <th>Severity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in analysis.recent_events %}
                        <tr>
                            <td>{{ event.created_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ event.get_event_type_display }}</td>
                            <td>
                                <span class="badge bg-{% if event.severity == 'critical' %}danger{% elif event.severity == 'warning' %}warning{% else %}info{% endif %}">
                                    {{ event.get_severity_display }}
                                </span>
                            </td>
                            <td>
                                {% if event.is_resolved %}
                                    <span class="badge bg-success">Opgelost</span>
                                {% else %}
                                    <span class="badge bg-warning">Open</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

    {% else %}
        <div class="no-data">
            <i class="bi bi-exclamation-circle"></i>
            <h4>Geen Data Beschikbaar</h4>
            <p>{{ analysis.message }}</p>
        </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'all_devices_without_power' %}" class="btn-modern btn-secondary-modern">
            <i class="bi bi-arrow-left"></i> Terug naar Overzicht
        </a>
        <a href="{% url 'device_suspicious_activity' device.id %}" class="btn-modern btn-primary-modern">
            <i class="bi bi-exclamation-triangle"></i> Suspicious Activity
        </a>
        <a href="{% url 'power_events_list' %}?device={{ device.id }}" class="btn-modern btn-primary-modern">
            <i class="bi bi-list"></i> Alle Power Events
        </a>
        <a href="{% url 'export_device_power_analysis' device.id %}" class="btn-modern btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export naar Excel
        </a>
        <a href="{% url 'device_power_history' device.id %}" class="btn-modern btn-info">
            <i class="bi bi-clock-history"></i> Device History
        </a>
    </div>
</div>

<!-- Counter Changes Modals -->
{% if analysis.power_incidents %}
    {% for incident in analysis.power_incidents %}
        {% if incident.counter_changes and incident.counter_changes|length > 3 %}
        <div class="modal fade" id="counterChangesModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="counterChangesModalLabel{{ forloop.counter }}" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="counterChangesModalLabel{{ forloop.counter }}">
                            <i class="bi bi-clock-history"></i> 
                            Counter Veranderingen - {{ incident.start_time|date:"d/m/Y H:i" }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Incident Details:</strong><br>
                                <small class="text-muted">
                                    Start: {{ incident.start_time|date:"d/m/Y H:i:s" }}<br>
                                    {% if incident.end_time %}
                                        Eind: {{ incident.end_time|date:"d/m/Y H:i:s" }}<br>
                                    {% endif %}
                                    Duur: 
                                    {% if incident.duration.days > 0 %}
                                        {{ incident.duration.days }}d 
                                    {% endif %}
                                    {% if incident.duration.seconds > 3600 %}
                                        {{ incident.duration.seconds|floatformat:0|add:"-3600"|floatformat:0|div:3600|floatformat:0 }}h
                                    {% elif incident.duration.seconds > 60 %}
                                        {{ incident.duration.seconds|floatformat:0|div:60|floatformat:0 }}m
                                    {% else %}
                                        {{ incident.duration.seconds }}s
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-md-6">
                                <strong>Counter Details:</strong><br>
                                <small class="text-muted">
                                    Start Counter: {{ incident.start_counter }} stuks<br>
                                    {% if incident.end_counter %}
                                        Eind Counter: {{ incident.end_counter }} stuks<br>
                                    {% endif %}
                                    <span class="text-danger fw-bold">
                                        Productie zonder stroom: {{ incident.total_production }} stuks
                                    </span>
                                </small>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            {% if incident.counter_changes_by_date %}
                                <!-- Grouped by date view -->
                                {% for date_group in incident.counter_changes_by_date %}
                                    <div class="card mb-3">
                                        <div class="card-header {% if date_group.is_today %}bg-primary text-white{% else %}bg-light{% endif %}">
                                            <h6 class="mb-0">
                                                {% if date_group.is_today %}
                                                    <i class="bi bi-calendar-day"></i> {{ date_group.date_display }} (Vandaag) - Totaal: +{{ date_group.total }} stuks
                                                {% else %}
                                                    <i class="bi bi-calendar"></i> {{ date_group.date_display }} - Totaal: +{{ date_group.total }} stuks
                                                {% endif %}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Tijdstip</th>
                                                        <th>Counter Waarde</th>
                                                        <th>Verandering</th>
                                                        <th>Accumulatie</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for change in date_group.changes %}
                                                    <tr>
                                                        <td>{{ change.timestamp|date:"H:i:s" }}</td>
                                                        <td>{{ change.counter_value }} stuks</td>
                                                        <td class="text-success">+{{ change.change }} stuks</td>
                                                        <td class="text-danger fw-bold">{{ change.counter_value|add:"-"|add:incident.start_counter }} stuks</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <!-- Original detailed view -->
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Tijdstip</th>
                                            <th>Counter Waarde</th>
                                            <th>Verandering</th>
                                            <th>Accumulatie</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for change in incident.counter_changes %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ change.timestamp|date:"d/m/Y H:i:s" }}</td>
                                            <td>{{ change.counter_value }} stuks</td>
                                            <td class="text-success">+{{ change.change }} stuks</td>
                                            <td class="text-danger fw-bold">{{ change.counter_value|add:"-"|add:incident.start_counter }} stuks</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
                        <a href="{% url 'export_power_outages' device.id %}" class="btn btn-success">
                            <i class="bi bi-file-earmark-excel"></i> Export naar Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% endif %}

<script>
// Auto-refresh every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %} 
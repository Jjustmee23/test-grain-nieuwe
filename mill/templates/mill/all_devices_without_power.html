{% extends 'mill/base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Alle Devices Zonder Stroom - Super Admin{% endblock %}

{% block content %}
<style>
    .devices-without-power {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .summary-card.critical {
        border-left: 5px solid #dc3545;
    }
    
    .summary-card.warning {
        border-left: 5px solid #ffc107;
    }
    
    .summary-card.info {
        border-left: 5px solid #17a2b8;
    }
    
    .summary-card h3 {
        margin: 0 0 10px 0;
        font-size: 2rem;
        font-weight: bold;
    }
    
    .summary-card p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    .devices-table {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .devices-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .devices-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .devices-table td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    
    .device-row.critical {
        background-color: #fff5f5;
        border-left: 4px solid #dc3545;
    }
    
    .device-row.warning {
        background-color: #fffbf0;
        border-left: 4px solid #ffc107;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-badge.critical {
        background: #dc3545;
        color: white;
    }
    
    .status-badge.warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-details {
        background: #007bff;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: background 0.3s;
    }
    
    .btn-details:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
    
    .no-devices {
        text-align: center;
        padding: 50px;
        color: #666;
    }
    
    .no-devices i {
        font-size: 3rem;
        color: #28a745;
        margin-bottom: 20px;
    }
</style>

<div class="devices-without-power">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-exclamation-triangle text-warning"></i> Alle Devices Zonder Stroom</h1>
        <a href="{% url 'power_dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Terug naar Dashboard
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
        <div class="summary-card critical">
            <h3>{{ summary.total_devices }}</h3>
            <p>Total Devices Zonder Stroom</p>
        </div>
        <div class="summary-card critical">
            <h3>{{ summary.critical_devices }}</h3>
            <p>Critical (Met Counter Activiteit)</p>
        </div>
        <div class="summary-card warning">
            <h3>{{ summary.warning_devices }}</h3>
            <p>Warning (Alleen Geen Stroom)</p>
        </div>
        <div class="summary-card info">
            <h3>{{ summary.total_production_without_power }}</h3>
            <p>Total Productie Zonder Stroom</p>
        </div>
    </div>

    <!-- Devices Table -->
    <div class="devices-table">
        {% if devices_without_power %}
            <table>
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Factory</th>
                        <th>Status</th>
                        <th>Stroom Verloren</th>
                        <th>Downtime</th>
                        <th>Productie Zonder Stroom</th>
                        <th>Incidenten</th>
                        <th>Acties</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device_info in devices_without_power %}
                    <tr class="device-row {{ device_info.severity }}">
                        <td>
                            <strong>{{ device_info.device.name }}</strong><br>
                            <small class="text-muted">{{ device_info.device.id }}</small>
                        </td>
                        <td>
                            {% if device_info.factory %}
                                {{ device_info.factory.name }}
                            {% else %}
                                <span class="text-muted">Geen factory</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge {{ device_info.severity }}">
                                {% if device_info.severity == 'critical' %}
                                    Critical
                                {% else %}
                                    Warning
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if device_info.power_loss_detected_at %}
                                {{ device_info.power_loss_detected_at|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-muted">Onbekend</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device_info.downtime_duration %}
                                {% if device_info.downtime_duration.days > 0 %}
                                    {{ device_info.downtime_duration.days }}d 
                                {% endif %}
                                {% if device_info.downtime_duration.seconds > 3600 %}
                                    {{ device_info.downtime_duration.seconds|floatformat:0|add:"-3600"|floatformat:0 }}h
                                {% elif device_info.downtime_duration.seconds > 60 %}
                                    {{ device_info.downtime_duration.seconds|floatformat:0|div:60|floatformat:0 }}m
                                {% else %}
                                    {{ device_info.downtime_duration.seconds }}s
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Onbekend</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if device_info.detailed_analysis.statistics.total_production_without_power > 0 %}
                                <span class="text-danger fw-bold">
                                    {{ device_info.detailed_analysis.statistics.total_production_without_power }} stuks
                                </span>
                            {% else %}
                                <span class="text-muted">0 stuks</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ device_info.detailed_analysis.statistics.total_incidents }} incidenten
                            {% if device_info.detailed_analysis.statistics.incidents_with_counter > 0 %}
                                <br><small class="text-danger">
                                    {{ device_info.detailed_analysis.statistics.incidents_with_counter }} met counter
                                </small>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'device_detailed_power_analysis' device_info.device.id %}" class="btn-details">
                                <i class="bi bi-eye"></i> Details
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-devices">
                <i class="bi bi-check-circle"></i>
                <h3>Geen Devices Zonder Stroom</h3>
                <p>Alle devices hebben momenteel stroom. Uitstekend!</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-refresh every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);
</script>
{% endblock %} 
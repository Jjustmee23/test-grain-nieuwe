{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إحصائيات مطحنة</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- Header with Logos and Title -->
    <div class="header">
        <img src="{% static 'pictures/logo-left.png' %}" alt="Left Logo" class="logo-left">
        <div>
            <h1>{% trans 'الشركة العامة لتصنيع الحبوب' %}</h1>
            <h2>{% trans 'نظام مراقبة عمل المطاحن' %}</h2>
        </div>
        <img src="{% static 'pictures/logo-right.png' %}" alt="Right Logo" class="logo-right">
    </div>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="header mb-3">
            <h1>{% trans 'إحصائيات مطحنة' %}</h1>
        </div>

        <!-- Filters and Buttons -->
        <div class="filters-reset mb-4">
            <form method="GET" action="/view_statistics" class="d-flex flex-column flex-md-row align-items-start">
                <div class="mb-2 mb-md-0 me-md-2">
                    <label for="date" class="form-label">تاريخ التحديد:</label>
                    <input type="date" id="date" name="date" class="form-control" value="{{ date|default:current_date }}">
                </div>
                <div class="d-flex mb-2 mb-md-0 me-md-2">
                    <input type="hidden" name="factory_id" value="{{ factory_id }}">
                    <button type="submit" class="btn btn-primary me-2">تصفية</button>
                    <form method="GET" action="/view_statistics" class="d-inline">
                        <input type="hidden" name="factory_id" value="{{ factory_id }}">
                        <input type="hidden" name="reset" value="true">
                        <button type="submit" class="btn btn-secondary me-2">إعادة إلى اليوم</button>
                    </form>
                    <a href="/" class="btn btn-secondary">العودة إلى لوحة التحكم</a>
                </div>
            </form>
        </div>

        <!-- Mill Performance Charts -->
        <div class="statistics-section mb-4">
            
            
            <!-- Charts for Daily, Weekly, Monthly, and Yearly Totals -->
            <div class="row">
                <div class="col-md-6">
                    <canvas id="dailyChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="col-md-6 mt-4">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="col-md-6 mt-4">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="logs-section mb-4">
            <h2>{% trans 'سجلات المطحنة' %}</h2>
            <!-- Form to filter logs by date -->
            <form method="GET" action="/view_statistics" class="d-flex flex-column flex-md-row align-items-start mb-3">
                <input type="hidden" name="factory_id" value="{{ factory_id }}">
                <label for="log_date" class="form-label me-2">تصفية السجلات حسب التاريخ:</label>
                <input type="date" id="log_date" name="log_date" class="form-control" value="{{ log_date|default:'' }}">
                <button type="submit" class="btn btn-primary mt-2">تصفية السجلات</button>
            </form>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>النوع</th>
                        <th>التفاصيل</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.date|date:"d/m/Y H:i" }}</td>
                        <td>{{ log.type }}</td>
                        <td>{{ log.details }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Errors Section -->
        <div class="errors-section mb-4">
            <h2>{% trans 'أخطاء المطحنة' %}</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>التاريخ</th>
                        <th>الرمز</th>
                        <th>الرسالة</th>
                    </tr>
                </thead>
                <tbody>
                    {% for error in errors %}
                    <tr>
                        <td>{{ error.date|date:"d/m/Y H:i" }}</td>
                        <td>{{ error.code }}</td>
                        <td>{{ error.message }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
    // Data for charts
    const dailyData = JSON.parse('{{ daily_totals|escapejs }}');
    const weeklyData = JSON.parse('{{ weekly_totals|escapejs }}');
    const monthlyData = JSON.parse('{{ monthly_totals|escapejs }}');
    const yearlyData = JSON.parse('{{ yearly_totals|escapejs }}');

    // Labels for charts
    const dailyLabels = ['الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت', 'الأحد'];
    const weeklyLabels = Array.from({ length: 7 }, (_, i) => `الأسبوع ${35 - 6 + i}`);  // Adjust for current week
    const monthlyLabels = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
    const yearlyLabels = ['2020', '2021', '2022', '2023', '2024'];  // Adjust based on actual data

    // Initialize charts
    const ctxDaily = document.getElementById('dailyChart').getContext('2d');
    const dailyChart = new Chart(ctxDaily, {
        type: 'bar',
        data: {
            labels: dailyLabels,  
            datasets: [{
                label: 'المجاميع اليومية',
                data: dailyData,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctxWeekly = document.getElementById('weeklyChart').getContext('2d');
    const weeklyChart = new Chart(ctxWeekly, {
        type: 'bar',
        data: {
            labels: weeklyLabels,  
            datasets: [{
                label: 'المجاميع الأسبوعية',
                data: weeklyData,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
    const monthlyChart = new Chart(ctxMonthly, {
        type: 'bar',
        data: {
            labels: monthlyLabels,  
            datasets: [{
                label: 'المجاميع الشهرية',
                data: monthlyData,
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const ctxYearly = document.getElementById('yearlyChart').getContext('2d');
    const yearlyChart = new Chart(ctxYearly, {
        type: 'bar',
        data: {
            labels: yearlyLabels,  
            datasets: [{
                label: 'المجاميع السنوية',
                data: yearlyData,
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Dark mode toggle functionality
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
    }
    </script>
</body>
</html>

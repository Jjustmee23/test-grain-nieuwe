{% extends 'mill/base.html' %}
{% load static %}
{% load i18n %}
{% block title %}{% trans "إحصائيات المطحنة" %}{% endblock %}

{% block content %}
<style>
.door-indicator {
    transition: all 0.3s ease;
}

.door-indicator.open {
    animation: pulse-red 2s infinite;
}

.door-indicator.closed {
    animation: pulse-green 2s infinite;
}

@keyframes pulse-red {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes pulse-green {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.card[onclick] {
    transition: all 0.3s ease;
}

.card[onclick]:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
<div class="statistics-page" style="margin: 12px;">
    <!-- Header Section -->
    <!-- <div class="header d-flex justify-content-between align-items-center p-3 bg-light">
        <img src="{% static 'images/logo-left.png' %}" alt="Logo Left" class="logo-left" style="height: 60px;">
        <div class="text-center">
            <h1 class="mb-0">{{ factory_name }}</h1>
            <h2 class="mb-0">إحصائيات المطحنة</h2>
        </div>
        <img src="{% static 'images/logo-right.png' %}" alt="Logo Right" class="logo-right" style="height: 60px;">
    </div> -->

    <!-- User Info and DateTime Section -->
    <div class="user-info-section bg-light py-2 px-3 mb-3">
        <div class="row">
            <div class="col-md-6">
                <p class="mb-0"><strong>المستخدم:</strong> {{ request.user.username }}</p>
            </div>
            <div class="col-md-6 text-end">
                <p class="mb-0" id="currentDateTime"></p>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <!-- Device Selection Header -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info" id="deviceInfo">
                    <i class="bi bi-cpu me-2"></i>
                    <strong>المصنع:</strong> {{ factory.name }} | 
                    <strong>الجهاز المحدد:</strong> 
                    <span id="selectedDeviceName">
                        {% if device_count == 1 %}
                            {{ devices.first.name }}
                        {% elif selected_device_id == 'all' %}
                            جميع الأجهزة
                        {% else %}
                            {% for device in devices %}
                                {% if device.id == selected_device_id %}
                                    {{ device.name }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        


        <!-- Refresh Indicator -->
        <div id="refreshIndicator" class="alert alert-info alert-dismissible fade show" role="alert" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1050;">
            <i class="bi bi-arrow-clockwise me-2"></i>
            <strong>تحديث فوري...</strong> جاري جلب أحدث البيانات من الأجهزة.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Power Status Box (Clickable) -->
        {% if user.is_superuser or user.power_management_permission.can_view_power_status %}
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-success h-100" style="cursor: pointer; transition: transform 0.2s ease;" 
                     onclick="window.location.href='{% url 'factory_power_overview' factory.id %}'"
                     onmouseover="this.style.transform='scale(1.02)'" 
                     onmouseout="this.style.transform='scale(1)'">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning-charge me-2"></i>
                            حالة الطاقة
                        </h6>
                    </div>
                    <div class="card-body text-center">
                        <div id="powerStatusBox">
                            <div class="spinner-border text-danger" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">جاري تحميل حالة الطاقة...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success h-100" style="cursor: pointer; transition: transform 0.2s ease;" 
                     onclick="showDoorHistoryModal()"
                     onmouseover="this.style.transform='scale(1.02)'" 
                     onmouseout="this.style.transform='scale(1)'">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-door-closed me-2"></i>
                            حالة الأبواب
                        </h6>
                    </div>
                    <div class="card-body text-center">
                        <div id="doorStatusBox">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">جاري تحميل حالة الأبواب...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}



        <!-- Control Buttons Section -->
        <div class="row mb-4">
            <div class="col-6 col-md-2 mb-2">
                <label for="datePicker" class="form-label small mb-1">التاريخ:</label>
                <input type="date" id="datePicker" class="form-control" onchange="refreshCharts()" value="{{ selected_date|date:'Y-m-d' }}" />
            </div>
            <div class="col-6 col-md-2 mb-2">
                <label for="deviceSelector" class="form-label small mb-1">الجهاز:</label>
                <select id="deviceSelector" class="form-control" onchange="handleDeviceChange();">
                    {% if device_count > 1 %}
                        <option value="all" {% if selected_device_id == 'all' %}selected{% endif %}>جميع الأجهزة</option>
                    {% endif %}
                    {% for device in devices %}
                        <option value="{{ device.id }}" {% if selected_device_id == device.id %}selected{% endif %}>{{ device.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6 col-md-2 mb-2">
                <button id="dateRangeBtn" class="btn btn-warning w-100" onclick="openDateRangeModal();">
                    <i class="bi bi-calendar-range me-2"></i>الحصول على القيمة
                </button>
            </div>

            <div class="col-6 col-md-2 mb-2">
                <button id="backToDashboard" class="btn btn-primary w-100" onclick="window.location.href='/dashboard';">
                    <i class="bi bi-speedometer2 me-2"></i>العودة إلى لوحة التحكم
                </button>
            </div>
            <div class="col-6 col-md-2 mb-2">
                <button id="downloadPDF" class="btn btn-success w-100" onclick="generatePDF();">
                    <i class="bi bi-file-pdf me-2"></i>تحميل PDF
                </button>
            </div>
            <div class="col-6 col-md-2 mb-2">
                <button id="refreshData" class="btn btn-info w-100" onclick="refreshCharts();">
                    <i class="bi bi-arrow-clockwise me-2"></i>تحديث البيانات
                </button>
            </div>

        </div>

        <!-- Factory Image Section -->
        <!-- <div class="row mb-4">
            <div class="col-12">
                <div class="factory-image-container text-center">
                    <img src="{% static 'images/factory-banner.jpg' %}" alt="Factory View" class="img-fluid rounded shadow" style="max-height: 200px; width: 100%; object-fit: cover;">
                </div>
            </div>
        </div> -->

        <!-- Device selection handled by existing green dropdown section -->

        <!-- Statistics Cards Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card text-white bg-success mb-3 shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>إجمالي يومي</span>
                        <i class="bi bi-calendar-day"></i>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="total-daily" data-daily-total>{{ daily_total|default:0 }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-secondary mb-3 shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>إجمالي أسبوعي</span>
                        <i class="bi bi-calendar-week"></i>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="total-week" data-weekly-total>{{ weekly_total|default:0 }}</h5>
                    </div>
                </div>
            </div>
        </div>

        <div class="row ">
            <div class="col-md-6">
                <div class="card text-white bg-warning mb-3 shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>إجمالي شهري</span>
                        <i class="bi bi-calendar-month"></i>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="total-month" data-monthly-total>{{ monthly_total|default:0 }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-white bg-danger mb-3 shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>إجمالي سنوي</span>
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="total-year" data-yearly-total>{{ yearly_total|default:0 }}</h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid py-4">
        {# Add this section where you want to display batch information #}
    {% if batches %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">معلومات الدفعات لـ {{ factory.name }}</h5>
                <span class="badge bg-primary">إجمالي الدفعات: {{ total_batches }}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>رقم الدفعة</th>
                                <th>تاريخ البداية</th>
                                <th>الحالة</th>
                                <th>كمية القمح</th>
                                <th>الإنتاج المتوقع</th>
                                <th>الإنتاج الفعلي</th>
                                <th>معدل الإنتاجية</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for batch in batches|safe %}
                            <tr>
                                <td>{{ batch.batch_number }}</td>
                                <td>{{ batch.start_date|date:"Y-m-d H:i" }}</td>
                                <td>
                                    <span class="badge {% if batch.is_completed %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ batch.status }}
                                    </span>
                                </td>
                                <td>{{ batch.wheat_amount|floatformat:2 }} tons</td>
                                <td>{{ batch.expected_flour_output|floatformat:2 }} tons</td>
                                <td>{{ batch.actual_flour_output|floatformat:2 }} tons</td>
                                <td>{{ batch.yield_rate|floatformat:1 }}%</td>
                                <td>
                                    <a href="{{ batch.detail_url }}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-eye"></i> عرض التفاصيل
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info">
    لا توجد معلومات دفعات متاحة لهذا المصنع.
</div>
{% endif %}
    </div>
        <!-- Charts Section -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
            <div class="chart-box bg-white p-3 rounded shadow">
                                    <h3 class="text-center mb-3">الإنتاج بالساعة</h3>
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
            <!-- First Row -->
            <div class="col-md-6 mb-4">
                <div class="chart-box bg-white p-3 rounded shadow">
                    <h3 class="text-center mb-3">إنتاج يومي</h3>
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="chart-box bg-white p-3 rounded shadow">
                    <h3 class="text-center mb-3">إنتاج شهري</h3>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Second Row -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">مقارنة الإنتاج</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="batchOutputComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">مقاييس الكفاءة</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="batchEfficiencyMetricsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Production Progress - Placed next to Efficiency Metrics -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="card-title mb-0 text-center">
                            <i class="bi bi-pie-chart me-2"></i>تقدم الإنتاج
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="circular-progress-container">
                            <!-- Circular Progress Chart -->
                            <div class="progress-circle-wrapper mb-3">
                                <div class="progress-circle-container">
                                    <canvas id="batchProgressChart" width="250" height="250"></canvas>
                                    <div class="progress-circle-text">
                                        <div class="progress-percentage" id="progressPercentage">0%</div>
                                        <div class="progress-label">مكتمل</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Batch Progress Info -->
                            <div class="text-center">
                                <div class="batch-info">
                                    <div class="batch-goal mb-2">
                                        <i class="bi bi-bullseye me-2"></i>
                                        <span class="fw-bold">هدف الدفعة: {{ factory.batch_goal|default:800 }} طن</span>
                                    </div>
                                    <div class="batch-progress">
                                        <i class="bi bi-bar-chart me-2"></i>
                                        <span class="text-muted">التقدم: <span id="currentFlour" class="fw-bold text-primary">0</span> طن (<span id="currentPercent" class="fw-bold text-success">0</span>%)</span>
                                    </div>
                                    <div class="batch-remaining mt-1">
                                        <i class="bi bi-hourglass-split me-2"></i>
                                        <span class="text-muted">المتبقي: <span id="remainingFlour" class="fw-bold text-warning">800</span> طن</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4" style="display: none;">
            <div class="col-md-6" style="width: 70%; margin-top: 7rem; margin: auto;">
            <div class="chart-box bg-white p-3 rounded shadow">
                <h3 class="text-center mb-3">إنتاج سنوي</h3>
                <canvas id="yearlyChart"></canvas>
            </div>
            </div>
        </div>
<!-- Production Progress moved to side-by-side layout with Efficiency Metrics -->

<!-- Circular Progress Chart CSS -->
<style>
.circular-progress-container {
    text-align: center;
    padding: 15px 0;
}

.progress-circle-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
}

.progress-circle-container {
    position: relative;
    width: 250px;
    height: 250px;
}

.progress-circle-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 10;
}

.progress-percentage {
    font-size: 2em;
    font-weight: bold;
    color: #495057;
    line-height: 1;
    margin-bottom: 5px;
}

.progress-label {
    font-size: 1em;
    color: #6c757d;
    font-weight: 500;
}

.batch-info {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.batch-goal, .batch-progress, .batch-remaining {
    padding: 5px 0;
}

.batch-goal i, .batch-progress i, .batch-remaining i {
    color: #6c757d;
}

/* Enhanced Production Statistics Card */
.production-stats-card {
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: none;
    border-radius: 15px;
    overflow: hidden;
}

.production-stats-card .card-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border-bottom: none;
    padding: 1.5rem;
}

.production-stats-card .card-title {
    font-size: 1.5rem;
    font-weight: 600;
}

.production-stats-card .btn-light {
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(255,255,255,0.3);
    color: #495057;
    font-weight: 500;
    transition: all 0.3s ease;
}

.production-stats-card .btn-light:hover,
.production-stats-card .btn-light.active {
    background: #ffffff;
    color: #28a745;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.chart-container {
    background: #ffffff;
    border-radius: 10px;
    padding: 10px;
}
</style>

<!-- Old progress bar CSS and JS removed - replaced with circular progress -->

<!-- Production Statistics Chart - Enhanced and Larger -->
<div class="row mb-4 justify-content-center">
    <div class="col-12 mb-4">
        <div class="card w-100 production-stats-card">
            <div class="card-header bg-gradient-success text-white d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0 text-center flex-grow-1">
                    <i class="bi bi-graph-up-arrow me-3"></i>إحصائيات الإنتاج
                </h4>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-light btn-sm active" data-time-scale="hourly">ساعي</button>
                    <button type="button" class="btn btn-light btn-sm" data-time-scale="daily">يومي</button>
                    <button type="button" class="btn btn-light btn-sm" data-time-scale="monthly">شهري</button>
                    <button type="button" class="btn btn-light btn-sm" data-time-scale="yearly">سنوي</button>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="chart-container" style="position: relative; height: 400px;">
                    <canvas id="batchProductionStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- Footer Section
        <div class="row mt-4">
            <div class="col-12">
                <div class="footer bg-light p-3 text-center rounded shadow">
                    <img src="{% static 'images/footer-logo.png' %}" alt="Footer Logo" style="height: 40px;">
                    <p class="mb-0 mt-2">© {{ current_year }} {{ factory_name }}. جميع الحقوق محفوظة</p>
                </div>
            </div>
        </div> -->
    </div>
    <input id="factoryId" hidden value={{factory.id}}></input>
</div>

<!-- Required CSS -->
<style>
    /* .statistics-page {
        background-color: #f8f9fa;
    } */
    .chart-box {
        background-color: white;
        /* border-radius: 8px; */
        /* margin-bottom: 20px; */
    }
    
    /* Device selector styling */
    #deviceSelector {
        border: 2px solid #007bff;
        border-radius: 5px;
        transition: all 0.3s ease;
    }
    
    #deviceSelector:focus {
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    /* Spinning animation for Bootstrap Icons */
    .spin {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }
    .card {
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
    .factory-image-container {
        overflow: hidden;
        /* border-radius: 8px; */
    }
    @media print {
        .btn {
            display: none;
        }
    }
    
    /* Modern Gauge Progress Bar Styles */
    .production-progress-container {
        padding: 20px 0;
    }
    
    .gauge-wrapper {
        text-align: center;
    }
    
    .gauge-container {
        position: relative;
        display: inline-block;
        margin: 0 auto;
    }
    
    .gauge {
        position: relative;
        width: 200px;
        height: 120px;
        margin: 0 auto;
    }
    
    .gauge-arc {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 100px 100px 0 0;
        background: conic-gradient(
            #dc3545 0deg 36deg,
            #fd7e14 36deg 72deg,
            #ffc107 72deg 108deg,
            #20c997 108deg 144deg,
            #28a745 144deg 180deg
        );
        transform: rotate(-90deg);
    }
    
    .gauge-needle {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 4px;
        height: 60px;
        background: #6c757d;
        transform-origin: bottom center;
        transform: translateX(-50%) rotate(0deg);
        transition: transform 1s ease-in-out;
        border-radius: 2px;
    }
    
    .gauge-needle::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid #6c757d;
    }
    
    .gauge-center {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        background: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .gauge-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #495057;
        line-height: 1;
    }
    
    .gauge-label {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 2px;
    }
    
    .gauge-stats {
        margin-top: 30px;
    }
    
    .stat-item {
        padding: 15px;
        border-radius: 8px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .milestone-card {
        transition: all 0.3s ease;
        cursor: pointer;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .milestone-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .milestone-card.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .milestone-card.bg-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    .milestone-value {
        font-weight: bold;
        font-size: 0.9em;
        margin: 2px 0;
    }
    
    .milestone-status {
        font-size: 0.75em;
        font-weight: 500;
    }
    
    .timeline-milestones h6 {
        color: #495057;
        font-weight: 600;
    }
    
    /* Animation for progress bar */
    @keyframes progressGlow {
        0% { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
        50% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.8); }
        100% { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
    }
    
    .progress-bar-animated {
        animation: progressGlow 2s ease-in-out infinite;
    }
</style>

<!-- Required JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome replaced with Bootstrap Icons (already loaded in base template) -->
<script src="{% static 'js/view_statistics.js' %}"></script>

<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1" aria-labelledby="dateRangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateRangeModalLabel">اختر نطاق التاريخ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="startDate" class="form-label">تاريخ البداية</label>
                        <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-6">
                        <label for="endDate" class="form-label">تاريخ النهاية</label>
                        <input type="date" class="form-control" id="endDate" required>
                    </div>
                </div>
                <div class="mt-3">
                                            <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>معلومات:</strong> اختر نطاق تاريخ لعرض بيانات الإنتاج بين هذه التواريخ.
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="getDateRangeData()">الحصول على البيانات</button>
            </div>
        </div>
    </div>
</div>

<!-- Date Range Results Modal -->
<div class="modal fade" id="dateRangeResultsModal" tabindex="-1" aria-labelledby="dateRangeResultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateRangeResultsModalLabel">Date Range Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6>Date Range</h6>
                                <h4 id="dateRangeDisplay">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6>Total Production</h6>
                                <h4 id="totalProductionDisplay">-</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="table-responsive">
                        <table class="table table-striped" id="dateRangeTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Production (Pieces)</th>
                                    <th>Production (Tons)</th>
                                    <th>Cumulative (Pieces)</th>
                                    <th>Cumulative (Tons)</th>
                                </tr>
                            </thead>
                            <tbody id="dateRangeTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="exportDateRangeData()">{% trans "Export Data" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
// Date Range Modal Functions
function openDateRangeModal() {
    const modal = new bootstrap.Modal(document.getElementById('dateRangeModal'));
    modal.show();
}

function getDateRangeData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const deviceId = document.getElementById('deviceSelector') ? document.getElementById('deviceSelector').value : 'all';
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates.');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('Start date cannot be after end date.');
        return;
    }
    
    // Close the modal
    const dateRangeModal = bootstrap.Modal.getInstance(document.getElementById('dateRangeModal'));
    dateRangeModal.hide();
    
    // Show loading
    showLoading();
    
    // Fetch data for the date range
    const apiUrl = deviceId === 'all' 
        ? `/api/chart_data/?factory_id={{ factory.id }}&start_date=${startDate}&end_date=${endDate}`
        : `/api/device-chart-data/{{ factory.id }}/?start_date=${startDate}&end_date=${endDate}&device_id=${deviceId}`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            displayDateRangeResults(startDate, endDate, data);
        })
        .catch(error => {
            hideLoading();
            console.error('Error fetching date range data:', error);
            alert('Error fetching data. Please try again.');
        });
}

function displayDateRangeResults(startDate, endDate, data) {
    // Calculate total production (pieces)
    let totalProductionPieces = 0;
    const dailyData = data.daily_data || [];
    
    dailyData.forEach(day => {
        totalProductionPieces += day;
    });
    
    // Convert to tons (1 piece = 50 kg = 0.05 tons)
    const totalProductionTons = totalProductionPieces * 0.05;
    
    // Update display
    document.getElementById('dateRangeDisplay').textContent = `${startDate} to ${endDate}`;
    document.getElementById('totalProductionDisplay').textContent = `${totalProductionPieces.toFixed(0)} pieces (${totalProductionTons.toFixed(2)} tons)`;
    
    // Populate table
    const tableBody = document.getElementById('dateRangeTableBody');
    tableBody.innerHTML = '';
    
    let cumulativePieces = 0;
    dailyData.forEach((productionPieces, index) => {
        cumulativePieces += productionPieces;
        const productionTons = productionPieces * 0.05;
        const cumulativeTons = cumulativePieces * 0.05;
        
        const date = new Date(startDate);
        date.setDate(date.getDate() + index);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${date.toISOString().split('T')[0]}</td>
            <td>${productionPieces.toFixed(0)}</td>
            <td>${productionTons.toFixed(2)}</td>
            <td>${cumulativePieces.toFixed(0)}</td>
            <td>${cumulativeTons.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
    });
    
    // Show results modal
    const resultsModal = new bootstrap.Modal(document.getElementById('dateRangeResultsModal'));
    resultsModal.show();
}

function showLoading() {
    // You can implement a loading spinner here
    document.getElementById('dateRangeBtn').innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i>Loading...';
    document.getElementById('dateRangeBtn').disabled = true;
}

function hideLoading() {
    document.getElementById('dateRangeBtn').innerHTML = '<i class="bi bi-calendar-range me-2"></i>Get Value';
    document.getElementById('dateRangeBtn').disabled = false;
}

function exportDateRangeData() {
    // Get the table data
    const table = document.getElementById('dateRangeTable');
    const rows = table.querySelectorAll('tbody tr');
    
    if (rows.length === 0) {
        alert('No data to export.');
        return;
    }
    
    // Prepare data for Excel
    const excelData = [
        ['Date', 'Production (Pieces)', 'Production (Tons)', 'Cumulative (Pieces)', 'Cumulative (Tons)']
    ];
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = Array.from(cells).map(cell => cell.textContent.trim());
        excelData.push(rowData);
    });
    
    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Set column widths
    const colWidths = [
        { wch: 12 }, // Date
        { wch: 18 }, // Production (Pieces)
        { wch: 18 }, // Production (Tons)
        { wch: 20 }, // Cumulative (Pieces)
        { wch: 20 }  // Cumulative (Tons)
    ];
    ws['!cols'] = colWidths;
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Production Data');
    
    // Get date range and device name for filename
    const dateRangeDisplay = document.getElementById('dateRangeDisplay').textContent;
    const deviceName = document.getElementById('selectedDeviceName').textContent;
    const filename = `production_data_${deviceName}_${dateRangeDisplay.replace(/\s/g, '_')}.xlsx`;
    
    // Generate and download Excel file
    XLSX.writeFile(wb, filename);
}
</script>

<script>
    // Update current date and time (single function to prevent flickering)
    function updateDateTime() {
        const now = new Date();
        const dateTimeString = now.toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const currentDateTimeElement = document.getElementById('currentDateTime');
        if (currentDateTimeElement) {
            currentDateTimeElement.textContent = dateTimeString;
        }
    }

    // Update time every second (only one interval)
    updateDateTime();
    const timeInterval = setInterval(updateDateTime, 1000);
    
    // Modern Gauge Progress Bar Animation
    function updateProductionProgress() {
        const dailyTotal = {{ daily_total|default:0 }};
        const weeklyTotal = {{ weekly_total|default:0 }};
        const monthlyTotal = {{ monthly_total|default:0 }};
        const yearlyTotal = {{ yearly_total|default:0 }};
        
        // Use daily total as current progress, monthly total as target
        const currentProgress = dailyTotal;
        const targetProgress = Math.max(monthlyTotal, 1000); // Use monthly total or 1000 as target
        const progressPercentage = Math.min((currentProgress / targetProgress) * 100, 100);
        
        // Update gauge needle (with null checks)
        const gaugeNeedle = document.getElementById('gaugeNeedle');
        const gaugeValue = document.getElementById('gaugeValue');
        
        if (gaugeNeedle && gaugeValue) {
        // Calculate needle rotation (0-180 degrees)
        const needleRotation = (progressPercentage / 100) * 180;
        
        // Animate needle
        let currentRotation = 0;
        const targetRotation = needleRotation;
        const animationDuration = 2000; // 2 seconds
        const animationSteps = 60;
        const rotationIncrement = targetRotation / animationSteps;
        
        const animation = setInterval(() => {
            currentRotation += rotationIncrement;
            if (currentRotation >= targetRotation) {
                currentRotation = targetRotation;
                clearInterval(animation);
            }
            
            gaugeNeedle.style.transform = `translateX(-50%) rotate(${currentRotation}deg)`;
            gaugeValue.textContent = `${(currentRotation / 180 * 100).toFixed(1)}%`;
        }, animationDuration / animationSteps);
        }
        
        // Update stats (with null checks)
        const dailyTotalEl = document.getElementById('dailyTotal');
        const weeklyTotalEl = document.getElementById('weeklyTotal');
        const monthlyTotalEl = document.getElementById('monthlyTotal');
        const yearlyTotalEl = document.getElementById('yearlyTotal');
        
        if (dailyTotalEl) dailyTotalEl.textContent = dailyTotal;
        if (weeklyTotalEl) weeklyTotalEl.textContent = weeklyTotal;
        if (monthlyTotalEl) monthlyTotalEl.textContent = monthlyTotal;
        if (yearlyTotalEl) yearlyTotalEl.textContent = yearlyTotal;
    }
    
    function updateMilestones(targetProgress, currentProgress) {
        const milestones = [25, 50, 75, 90, 100];
        const currentProgressPercentage = (currentProgress / targetProgress) * 100;
        
        milestones.forEach(milestone => {
            const milestoneCard = document.getElementById(`milestone-${milestone}`);
            const milestoneValue = document.getElementById(`milestone-${milestone}-value`);
            const milestoneStatus = document.getElementById(`milestone-${milestone}-status`);
            
            const milestoneAmount = (targetProgress * milestone / 100).toFixed(2);
            milestoneValue.textContent = `${milestoneAmount} tons`;
            
            if (currentProgressPercentage >= milestone) {
                milestoneCard.classList.add('bg-success', 'text-white');
                milestoneCard.classList.remove('border');
                milestoneStatus.textContent = 'Completed';
                milestoneStatus.className = 'milestone-status text-success';
            } else {
                milestoneCard.classList.remove('bg-success', 'text-white');
                milestoneCard.classList.add('border');
                milestoneStatus.textContent = 'Pending';
                milestoneStatus.className = 'milestone-status text-muted';
            }
        });
        
        // Update current milestone
        const currentCard = document.getElementById('milestone-current');
        const currentValue = document.getElementById('milestone-current-value');
        const currentStatus = document.getElementById('milestone-current-status');
        
        currentValue.textContent = `${currentProgress.toFixed(2)} tons`;
        currentStatus.textContent = 'Active';
        currentStatus.className = 'milestone-status text-primary';
        currentCard.classList.add('bg-primary', 'text-white');
        currentCard.classList.remove('border');
    }
    
    // Initialize progress bar when page loads
    document.addEventListener('DOMContentLoaded', function() {
        updateProductionProgress();
    });

    // PDF Generation
    function generatePDF() {
        const element = document.querySelector('.statistics-page');
        const opt = {
            margin: 1,
            filename: 'mill-statistics.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        };

        // Show loading message
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'position-fixed top-50 start-50 translate-middle bg-white p-1 rounded shadow';
        loadingDiv.innerHTML = '<div class="text-center"><i class="bi bi-arrow-clockwise spin"></i> جاري إنشاء PDF...</div>';
        document.body.appendChild(loadingDiv);

        html2pdf().set(opt).from(element).save().then(() => {
            document.body.removeChild(loadingDiv);
        });
    }
</script>
  <!-- <script>
        // Add this to your existing JavaScript
        function showBatchDetails(batchId) {
            // Find the batch data from the existing batches
            const batch = window.batchData.find(b => b.id === parseInt(batchId));
            if (!batch) return;

            // Update modal content
            const content = document.getElementById('batchDetailsContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Production Information</h6>
                        <dl class="row">
                            <dt class="col-sm-5">Wheat Amount:</dt>
                            <dd class="col-sm-7">${batch.wheat_amount.toFixed(2)} tons</dd>
                            
                            <dt class="col-sm-5">Expected Output:</dt>
                            <dd class="col-sm-7">${batch.expected_flour_output.toFixed(2)} tons</dd>
                            
                            <dt class="col-sm-5">Actual Output:</dt>
                            <dd class="col-sm-7">${batch.actual_flour_output.toFixed(2)} tons</dd>
                            
                            <dt class="col-sm-5">Yield Rate:</dt>
                            <dd class="col-sm-7">${batch.yield_rate.toFixed(1)}%</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6>Time Information</h6>
                        <dl class="row">
                            <dt class="col-sm-5">Start Date:</dt>
                            <dd class="col-sm-7">${new Date(batch.start_date).toLocaleString()}</dd>
                            
                            <dt class="col-sm-5">Status:</dt>
                            <dd class="col-sm-7">
                                <span class="badge ${batch.is_completed ? 'bg-success' : 'bg-warning'}">
                                    ${batch.status}
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>
                ${batch.alerts.length > 0 ? `
                    <div class="mt-3">
                        <h6>Alerts</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Severity</th>
                                        <th>Message</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${batch.alerts.map(alert => `
                                        <tr>
                                            <td>${alert.type}</td>
                                            <td>
                                                <span class="badge bg-${alert.severity.toLowerCase()}">
                                                    ${alert.severity}
                                                </span>
                                            </td>
                                            <td>${alert.message}</td>
                                            <td>${new Date(alert.created_at).toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : ''}
            `;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('batchDetailsModal'));
            modal.show();
        }

        // Add this to your page to make batch data available to JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            window.batchData = {{ batches|safe }};
            // Initialize any necessary functionality
            console.log('Batch data loaded:', window.batchData);
        });
    </script> -->
    <!-- Batch Production Timeline Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const batches = {{ batches|safe }};
    batches.forEach(batch => {
        const timelineCtx = document.getElementById('batchProductionTimelineChart').getContext('2d');
        new Chart(timelineCtx, {
            type: 'line',
            data: {
                labels: ['Start', '25%', '50%', '75%', 'Current'],
                datasets: [{
                    label: `Expected Output (${batch.batch_number})`,
                    data: [0, 
                        batch.expected_flour_output * 0.25,
                        batch.expected_flour_output * 0.5,
                        batch.expected_flour_output * 0.75,
                        batch.expected_flour_output
                    ],
                    borderColor: `rgba(54, 162, 235, ${0.5 + batches.indexOf(batch) * 0.2})`,
                    fill: false
                },
                {
                    label: `Actual Output (${batch.batch_number})`,
                    data: [0,
                        batch.actual_flour_output * 0.25,
                        batch.actual_flour_output * 0.5,
                        batch.actual_flour_output * 0.75,
                        batch.actual_flour_output
                    ],
                    borderColor: `rgba(255, 99, 132, ${0.5 + batches.indexOf(batch) * 0.2})`,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Production Progress Over Time'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Output (tons)'
                        }
                    }
                }
            }
        });
    });
});
</script>

<!-- Batch Output Comparison Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const batches = {{ batches|safe }};
    const outputCtx = document.getElementById('batchOutputComparisonChart').getContext('2d');
    
    const datasets = batches.map(batch => ({
        label: `Batch ${batch.batch_number}`,
        data: [
            batch.wheat_amount,
            batch.expected_flour_output,
            batch.actual_flour_output
        ],
        backgroundColor: [
            `rgba(255, 206, 86, ${0.5 + batches.indexOf(batch) * 0.2})`,
            `rgba(54, 162, 235, ${0.5 + batches.indexOf(batch) * 0.2})`,
            `rgba(255, 99, 132, ${0.5 + batches.indexOf(batch) * 0.2})`
        ],
        borderWidth: 1
    }));

    new Chart(outputCtx, {
        type: 'bar',
        data: {
            labels: ['Wheat Input', 'Expected Output', 'Actual Output'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Input vs Output Comparison'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Amount (tons)'
                    }
                }
            }
        }
    });
});
</script>

<!-- Batch Efficiency Metrics Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const batches = {{ batches|safe }};
    const efficiencyCtx = document.getElementById('batchEfficiencyMetricsChart').getContext('2d');

    const datasets = batches.map(batch => {
        const yieldRate = (batch.actual_flour_output / batch.expected_flour_output) * 100;
        return {
            label: `Batch ${batch.batch_number}`,
            data: [yieldRate, batch.waste_factor],
            backgroundColor: [
                `rgba(75, 192, 192, ${0.5 + batches.indexOf(batch) * 0.2})`,
                `rgba(255, 99, 132, ${0.5 + batches.indexOf(batch) * 0.2})`
            ],
            borderWidth: 1
        };
    });

    new Chart(efficiencyCtx, {
        type: 'bar',
        data: {
            labels: ['Yield Rate', 'Waste Factor'],
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Efficiency Metrics (%)'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
});
</script>

<!-- Batch Production Stats Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let productionStatsChart = null;
    const productionStatsCtx = document.getElementById('batchProductionStatsChart');
    const batches = {{ batches|safe }};

    function createProductionStatsChart(timeScale) {
        if (productionStatsChart) {
            productionStatsChart.destroy();
        }

        const datasets = batches.map(batch => ({
            label: `Batch ${batch.batch_number}`,
            data: generateTimeScaleData(batch, timeScale),
            backgroundColor: `rgba(75, 192, 192, ${0.5 + batches.indexOf(batch) * 0.2})`,
            borderColor: `rgba(75, 192, 192, ${0.7 + batches.indexOf(batch) * 0.2})`,
            borderWidth: 1
        }));

        productionStatsChart = new Chart(productionStatsCtx, {
            type: 'bar',
            data: {
                labels: getTimeScaleLabels(timeScale),
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    x: { 
                        title: { 
                            display: true, 
                            text: 'Time Period',
                            font: { weight: 'bold' }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: 'Production (tons)',
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `${timeScale.charAt(0).toUpperCase() + timeScale.slice(1)} Production Statistics`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    }
                }
            }
        });
    }

    function generateTimeScaleData(batch, timeScale) {
        // Generate mock data based on the time scale
        // In a real application, this would come from your backend
        switch(timeScale) {
            case 'hourly':
                return Array(24).fill().map(() => Math.random() * batch.actual_flour_output / 24);
            case 'daily':
                return Array(7).fill().map(() => Math.random() * batch.actual_flour_output / 7);
            case 'monthly':
                return Array(12).fill().map(() => Math.random() * batch.actual_flour_output / 12);
            case 'yearly':
                return Array(2).fill().map(() => batch.actual_flour_output);
            default:
                return [];
        }
    }

    function getTimeScaleLabels(timeScale) {
        switch(timeScale) {
            case 'hourly':
                return Array(24).fill().map((_, i) => `${i}:00`);
            case 'daily':
                return ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            case 'monthly':
                return ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            case 'yearly':
                return ['Previous Year', 'Current Year'];
            default:
                return [];
        }
    }

    // Initialize with hourly data
    createProductionStatsChart('hourly');

    // Add event listeners for time scale buttons
    document.querySelectorAll('[data-time-scale]').forEach(button => {
        button.addEventListener('click', (e) => {
            const timeScale = e.target.dataset.timeScale;
            document.querySelectorAll('[data-time-scale]').forEach(btn => {
                btn.classList.remove('active');
            });
            e.target.classList.add('active');
            createProductionStatsChart(timeScale);
        });
    });
});

// Power Status Functions (Super Admin Only)
        {% if user.is_superuser or user.power_management_permission.can_view_power_status %}
        function loadPowerStatus() {
            const factoryId = {{ factory.id }};
            
            fetch(`/api/power-status/${factoryId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Power status error:', data.error);
                        return;
                    }
                    
                    updatePowerStatusDisplay(data);
                })
                .catch(error => {
                    console.error('Error loading power status:', error);
                });
        }

        function updatePowerStatusDisplay(data) {
            const container = document.getElementById('powerStatusContainer');
            
            if (!container) return;
            
            const { summary, devices } = data;
            
            // Create summary cards
            const summaryHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="bi bi-check-circle fs-1"></i>
                            <h4 class="mt-2">${summary.devices_with_power}</h4>
                            <p class="mb-0">Devices with Power</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                            <h4 class="mt-2">${summary.devices_without_power}</h4>
                            <p class="mb-0">Devices without Power</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="bi bi-cpu fs-1"></i>
                            <h4 class="mt-2">${summary.total_devices}</h4>
                            <p class="mb-0">Total Devices</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <i class="bi bi-lightning fs-1"></i>
                            <h4 class="mt-2">${summary.recent_events_24h}</h4>
                            <p class="mb-0">Events (24h)</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Create device status cards
            const deviceHTML = devices.map(device => {
                return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card ${device.has_power ? 'border-success' : 'border-danger'} device-power-card" 
                         style="cursor: pointer; transition: transform 0.2s ease;" 
                         onclick="window.location.href='/device-power-status/${device.device_id}/'"
                         onmouseover="this.style.transform='scale(1.02)'" 
                         onmouseout="this.style.transform='scale(1)'">
                        <div class="card-header ${device.has_power ? 'bg-success' : 'bg-danger'} text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-cpu me-2"></i>
                                    ${device.device_name}
                                </h6>
                                <span class="badge ${device.has_power ? 'bg-light text-success' : 'bg-light text-danger'}">
                                    ${device.has_power ? 'POWER ON' : 'POWER OFF'}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">AIN1 Value:</small><br>
                                    <strong>${device.ain1_value !== null ? device.ain1_value.toFixed(2) : 'N/A'}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Last Check:</small><br>
                                    <strong>${device.last_check ? new Date(device.last_check).toLocaleString() : 'N/A'}</strong>
                                </div>
                            </div>
                            ${device.power_loss_detected_at ? `
                                <div class="mt-2">
                                    <small class="text-muted">Power Lost:</small><br>
                                    <strong class="text-danger">${new Date(device.power_loss_detected_at).toLocaleString()}</strong>
                                </div>
                            ` : ''}
                            ${device.production_during_power_loss ? `
                                <div class="mt-2">
                                    <span class="badge bg-danger">⚠️ Production without Power</span>
                                </div>
                            ` : ''}
                            <div class="mt-3 text-center">
                                <small class="text-muted">
                                    <i class="bi bi-arrow-right-circle me-1"></i>
                                    Click to view detailed power status
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = summaryHTML + deviceHTML;
        }

        // Auto-refresh power status every 5 minutes - DISABLED
        // setInterval(loadPowerStatus, 5 * 60 * 1000);

        // Load power status on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPowerStatus();
        });
        {% endif %}

        // Auto-refresh both status boxes every 30 seconds for real-time data - DISABLED
        // setInterval(function() {
        //     updateStatusBoxes();
        // }, 30 * 1000);
</script>


<script>
// Add this to your existing JavaScript
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
}

// Update the table rows with formatted dates
document.addEventListener('DOMContentLoaded', function() {
    const batchesData = JSON.parse('{{ batches|safe }}');
    const tbody = document.querySelector('table tbody');
    
    if (tbody && batchesData) {
        tbody.innerHTML = batchesData.map(batch => `
            <tr>
                <td>${batch.batch_number}</td>
                <td>${formatDate(batch.start_date)}</td>
                <td>
                    <span class="badge ${batch.is_completed ? 'bg-success' : 'bg-warning'}">
                        ${batch.status}
                    </span>
                </td>
                <td>${batch.wheat_amount.toFixed(2)} tons</td>
                <td>${batch.expected_flour_output.toFixed(2)} tons</td>
                <td>${batch.actual_flour_output.toFixed(2)} tons</td>
                <td>${batch.yield_rate.toFixed(1)}%</td>
                <td>
                    <a href="${batch.detail_url}" class="btn btn-sm btn-primary">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                </td>
            </tr>
        `).join('');
    }
});



// Load power status box on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load power status box
    {% if user.is_superuser or user.power_management_permission.can_view_power_status %}
    loadPowerStatusBox();
    {% endif %}
    
    // Load door status box
    loadDoorStatusBox();
});

// Power Status Box Functions
{% if user.is_superuser or user.power_management_permission.can_view_power_status %}
function loadPowerStatusBox() {
    const factoryId = {{ factory.id }};
    const selectedDeviceId = document.getElementById('deviceSelector').value;
    updatePowerStatusBoxForDevice(factoryId, selectedDeviceId);
}

function updatePowerStatusBoxForDevice(deviceId) {
    const container = document.getElementById('powerStatusBox');
    const factoryId = {{ factory.id }};
    const deviceSelector = document.getElementById('deviceSelector');
    const selectedDeviceName = deviceSelector ? deviceSelector.options[deviceSelector.selectedIndex].text : 'All Devices';
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Updating power status...</p>
        </div>
    `;
    
    // Fetch power data from unified power management service (same as power management)
    fetch(`/api/power-status/${factoryId}/?device_id=${deviceId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Unified power management data received:', data);
            
            if (data.error) {
                console.error('Power data error:', data.error);
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading power data
                    </div>
                `;
                return;
            }
            
            const summary = data.summary;
            const devices = data.devices;
            const recentEvents = data.recent_events;
            
            console.log('Selected device name:', selectedDeviceName);
            console.log('Devices data:', devices);
            console.log('Recent events:', recentEvents);
            
            // Find the specific device or first device for display
            let displayDevice = null;
            if (deviceId !== 'all' && devices && devices.length > 0) {
                displayDevice = devices.find(d => d.device_id == deviceId) || devices[0];
            } else if (devices && devices.length > 0) {
                displayDevice = devices[0];
            }
            
            console.log('Display device:', displayDevice);
            console.log('Display device AIN1 value:', displayDevice ? displayDevice.ain1_value : 'No device');
            console.log('Data source:', data.data_source);
            
            // Use unified power management status information
            let statusText = displayDevice ? (displayDevice.has_power ? 'POWER ON' : 'POWER OFF') : 'POWER ON';
            let statusClass = displayDevice ? (displayDevice.has_power ? 'text-success' : 'text-danger') : 'text-success';
            let statusIcon = displayDevice && !displayDevice.has_power ? 'bi-exclamation-triangle' : 'bi-lightning-charge';
            
            // Determine border color based on power status
            let borderClass = 'border-success'; // Green border for power ON
            if (displayDevice && !displayDevice.has_power) {
                // Check if there are power losses today
                if (displayDevice.power_loss_count_today > 0) {
                    borderClass = 'border-danger'; // Red border for power OFF with counting
                } else {
                    borderClass = 'border-warning'; // Orange border for power OFF
                }
            }
            
            // Update power status card border color
            const powerStatusCard = container.closest('.card');
            if (powerStatusCard) {
                powerStatusCard.className = `card ${borderClass} h-100`;
                
                // Update header color based on power status
                const header = powerStatusCard.querySelector('.card-header');
                if (header) {
                    if (displayDevice && !displayDevice.has_power) {
                        if (displayDevice.power_loss_count_today > 0) {
                            header.className = 'card-header bg-danger text-white'; // Red header for power OFF with counting
                        } else {
                            header.className = 'card-header bg-warning text-dark'; // Orange header for power OFF
                        }
                    } else {
                        header.className = 'card-header bg-success text-white'; // Green header for power ON
                    }
                }
            }
            
            const deviceName = deviceId === 'all' ? selectedDeviceName : (displayDevice ? displayDevice.device_name : selectedDeviceName);
            const lastCheck = displayDevice && displayDevice.last_update ? new Date(displayDevice.last_update).toLocaleString() : 'N/A';
            const ain1Value = displayDevice ? (displayDevice.ain1_value !== null && displayDevice.ain1_value !== undefined ? 
                (typeof displayDevice.ain1_value === 'number' ? displayDevice.ain1_value.toFixed(2) : parseFloat(displayDevice.ain1_value).toFixed(2)) : '0.00') : '0.00';
            
            // Build status display
            let statusHtml = `
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi ${statusIcon} fs-1 ${statusClass} me-3"></i>
                            <div>
                                <h4 class="mb-0 ${statusClass}">${statusText}</h4>
                                <small class="text-muted">Last updated: ${new Date().toLocaleString()}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <p class="mb-1"><strong>Device:</strong> ${deviceName}</p>
                        <p class="mb-1"><strong>Last Update:</strong> ${lastCheck}</p>
                        <p class="mb-1"><strong>AIN1 Value:</strong> ${ain1Value}</p>
                        ${displayDevice && displayDevice.power_loss_count_today > 0 ? `<p class="mb-1 text-warning"><strong>Power Losses Today:</strong> ${displayDevice.power_loss_count_today}</p>` : ''}
                        ${displayDevice && displayDevice.power_restore_count_today > 0 ? `<p class="mb-1 text-success"><strong>Power Restores Today:</strong> ${displayDevice.power_restore_count_today}</p>` : ''}
                        ${displayDevice && displayDevice.uptime_percentage < 100 ? `<p class="mb-1 text-info"><strong>Uptime Today:</strong> ${displayDevice.uptime_percentage.toFixed(1)}%</p>` : ''}
                        ${displayDevice && displayDevice.last_power_loss ? `<p class="mb-1 text-danger"><strong>Last Power Loss:</strong> ${new Date(displayDevice.last_power_loss).toLocaleString()}</p>` : ''}
                        ${displayDevice && displayDevice.last_power_restore ? `<p class="mb-1 text-success"><strong>Last Power Restore:</strong> ${new Date(displayDevice.last_power_restore).toLocaleString()}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Recent events removed - click on the box to view power overview page
            
            // Summary statistics removed - click on the box to view power overview page
            
            // Add click instruction
            statusHtml += `
                <div class="row mt-3">
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="bi bi-arrow-right-circle me-1"></i>
                            Click to view power overview
                        </small>
                    </div>
                </div>
            `;
            
            container.innerHTML = statusHtml;
        })
        .catch(error => {
            console.error('Error fetching power data:', error);
            container.innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading power data
                </div>
            `;
        });
}

// Door Status Box Functions
function loadDoorStatusBox() {
    updateStatusBoxes();
}

function updateStatusBoxes() {
    const selectedDeviceId = document.getElementById('deviceSelector').value;
    const factoryId = {{ factory.id }};
    
    // Show refresh indicator
    showRefreshIndicator();
    
    // Update door status box
    updateDoorStatusBoxForDevice(factoryId, selectedDeviceId);
    
    // Update power status box
    updatePowerStatusBoxForDevice(selectedDeviceId);
}

// Initialize power status update
document.addEventListener('DOMContentLoaded', function() {
    // Get the current selected device from the selector
    const deviceSelector = document.getElementById('deviceSelector');
    const selectedDeviceId = deviceSelector ? deviceSelector.value : 'all';
    
    // Initial update with the selected device
    updatePowerStatusBoxForDevice(selectedDeviceId);
    
    // Set up periodic updates every 30 seconds - DISABLED
    // setInterval(() => {
    //     const selectedDeviceId = document.getElementById('deviceSelector').value;
    //     updatePowerStatusBoxForDevice(selectedDeviceId);
    // }, 30000);
});

function showRefreshIndicator() {
    // Add a small refresh indicator to the page
    const indicator = document.getElementById('refreshIndicator');
    if (indicator) {
        indicator.style.display = 'block';
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }
}

function updateDoorStatusBoxForDevice(factoryId, deviceId) {
    const container = document.getElementById('doorStatusBox');
    
    if (!container) return;
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading door status...</p>
        </div>
    `;
    
    fetch(`/api/door-status/${factoryId}/?device_id=${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Door status error:', data.error);
                container.innerHTML = `
                    <div class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading door status
                    </div>
                `;
                return;
            }
            
            updateDoorStatusBox(data, deviceId);
        })
        .catch(error => {
            console.error('Error loading door status:', error);
            container.innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading door status
                </div>
            `;
        });
}

function updateDoorStatusBox(data, deviceId) {
    const container = document.getElementById('doorStatusBox');
    const doorStatusCard = container.closest('.card');
    
    if (!container) return;
    
    const { door_statuses, total_doors, open_doors, closed_doors } = data;
    const selectedDeviceName = deviceId === 'all' ? 'All Devices' : 
        Array.from(document.getElementById('deviceSelector').options)
            .find(option => option.value === deviceId)?.text || 'Selected Device';
    
    let statusText = 'ALL CLOSED';
    let statusClass = 'text-success';
    let statusIcon = 'bi-door-closed';
    let borderClass = 'border-success'; // Green border for closed doors
    
    if (open_doors > 0) {
        statusText = `${open_doors} OPEN`;
        statusClass = 'text-danger';
        statusIcon = 'bi-door-open';
        borderClass = 'border-danger'; // Red border for open doors
    }
    
    // Update card border color
    if (doorStatusCard) {
        doorStatusCard.className = `card ${borderClass} h-100`;
        
        // Update header color based on door status
        const header = doorStatusCard.querySelector('.card-header');
        if (header) {
            if (open_doors > 0) {
                header.className = 'card-header bg-danger text-white'; // Red header for open doors
            } else {
                header.className = 'card-header bg-success text-white'; // Green header for closed doors
            }
        }
    }
    
    container.innerHTML = `
        <div class="mb-3">
            <h4 class="${statusClass}">
                <i class="bi ${statusIcon} me-2"></i>
                ${statusText}
            </h4>
        </div>
        <div class="row text-start">
            <div class="col-12">
                <p class="mb-1"><strong>Device:</strong> ${selectedDeviceName}</p>
                <p class="mb-1"><strong>Total Doors:</strong> ${total_doors}</p>
                <p class="mb-1"><strong>Closed:</strong> ${closed_doors}</p>
                <p class="mb-1"><strong>Open:</strong> ${open_doors}</p>
            </div>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-clock-history me-1"></i>
                Click to view door history
            </small>
            <br>
            <small class="text-muted">
                <i class="bi bi-clock me-1"></i>
                Last updated: <span id="doorLastUpdated">${new Date().toLocaleString()}</span>
            </small>
        </div>
    `;
}

{% endif %}

// Door History Modal Functions
function showDoorHistoryModal() {
    // Create modal for door history
    const modalHtml = `
        <div class="modal fade" id="doorHistoryModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-door-open me-2"></i>
                            Door History - {{ factory.name }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Current Door Status</h6>
                                        <div id="currentDoorStatus">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">Today's Summary</h6>
                                        <div id="doorSummary">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="doorHistoryContent">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading door history...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="refreshDoorHistory()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('doorHistoryModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('doorHistoryModal'));
    modal.show();
    
    // Load door history data
    loadDoorHistory();
}

function loadDoorHistory() {
    const content = document.getElementById('doorHistoryContent');
    const currentStatus = document.getElementById('currentDoorStatus');
    const summary = document.getElementById('doorSummary');
    
    fetch(`/api/door-history-modal/{{ factory.id }}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading door history: ${data.error}
                    </div>
                `;
                return;
            }
            
            const { door_statuses, total_doors, open_doors, closed_doors, recent_logs } = data;
            
            // Update current status
            if (currentStatus) {
                const statusText = open_doors > 0 ? `${open_doors} OPEN` : 'ALL CLOSED';
                const statusClass = open_doors > 0 ? 'text-danger' : 'text-success';
                const statusIcon = open_doors > 0 ? 'bi-door-open' : 'bi-door-closed';
                
                currentStatus.innerHTML = `
                    <h4 class="${statusClass}">
                        <i class="bi ${statusIcon} me-2"></i>
                        ${statusText}
                    </h4>
                    <p class="mb-0">Total Doors: ${total_doors}</p>
                `;
            }
            
            // Update summary
            if (summary) {
                const today = new Date().toDateString();
                const todayEvents = recent_logs ? recent_logs.filter(log => 
                    new Date(log.timestamp).toDateString() === today
                ) : [];
                
                summary.innerHTML = `
                    <h4 class="text-primary">${todayEvents.length}</h4>
                    <p class="mb-0">Events Today</p>
                    <small class="text-muted">Open: ${open_doors} | Closed: ${closed_doors}</small>
                    <br><small class="text-info">Total Events: ${recent_logs.length}</small>
                `;
            }
            
            const recentLogs = recent_logs || [];
            
            if (recentLogs.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        No door events found for this factory
                    </div>
                `;
                return;
            }
            
            // Take only the last 20 events
            const last20Events = recentLogs.slice(0, 20);
            
            const logsHtml = last20Events.map(log => {
                const eventDate = new Date(log.timestamp);
                const isToday = eventDate.toDateString() === new Date().toDateString();
                const timeAgo = getTimeAgo(eventDate);
                const duration = log.duration_minutes ? `${log.duration_minutes.toFixed(1)} min` : 'Still Open';
                
                return `
                <div class="card mb-2 border-${log.is_resolved ? 'success' : 'warning'}">
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong>${log.device_name || 'Unknown Device'}</strong>
                                <br>
                                <small class="text-muted">${isToday ? timeAgo : eventDate.toLocaleDateString()}</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">DIN Data:</small><br>
                                <strong>${log.din_data || 'N/A'}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Duration:</small><br>
                                <strong>${duration}</strong>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="badge ${log.is_resolved ? 'bg-success' : 'bg-warning'}">
                                    ${log.is_resolved ? 'Closed' : 'Open'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <h6 class="mb-3">
                    <i class="bi bi-clock-history me-2"></i>
                    Recent Door Events (Last 20)
                </h6>
                <div class="door-history-list">
                    ${logsHtml}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading door history:', error);
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading door history: ${error.message}
                </div>
            `;
        });
}

function refreshDoorHistory() {
    loadDoorHistory();
}

function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    return `${Math.floor(diffInSeconds / 86400)}d ago`;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // === FACTORY 395 CRITICAL FIX ===
    // DISABLE refreshCharts() on initial load to prevent values disappearing
    console.log('🚨 DISABLING refreshCharts() for Factory 395 to prevent value reset');
    
    // Only update status boxes (doors/power), not charts that reset production values
    updateStatusBoxes();
    
    // Set up auto-refresh for charts (every 5 minutes) - BUT PRESERVE VALUES
    setInterval(function() {
        console.log('🔄 Auto-refresh triggered, preserving production values...');
        // Call original refresh but force values afterward
        if (typeof refreshCharts === 'function') {
            refreshCharts();
        }
        // Re-force production values after any refresh
        setTimeout(function() {
            forceUpdateValues();
            console.log('✅ Production values re-forced after auto-refresh');
        }, 1000);
    }, 300000);
    
    // === FACTORY 395 DEBUG & FIX ===
    console.log('=== FACTORY 395 DEBUG VALUES ===');
    console.log('Daily Total (server): {{ daily_total|default:0 }}');
    console.log('Weekly Total (server): {{ weekly_total|default:0 }}');
    console.log('Monthly Total (server): {{ monthly_total|default:0 }}');
    console.log('Yearly Total (server): {{ yearly_total|default:0 }}');
    
    // Force update values immediately - GLOBAL FUNCTION
    window.forceUpdateValues = function() {
        // Check if we're in device-specific mode (URL has device_id parameter)
        const urlParams = new URLSearchParams(window.location.search);
        const deviceId = urlParams.get('device_id');
        
        // If device_id is specified and not 'all', don't force update production totals
        // as they should be managed by updateProductionTotals function
        if (deviceId && deviceId !== 'all') {
            console.log('🔧 Skipping force update - device-specific mode active for device:', deviceId);
            return;
        }
        
        const dailyValue = {{ daily_total|default:0 }};
        const weeklyValue = {{ weekly_total|default:0 }};
        const monthlyValue = {{ monthly_total|default:0 }};
        const yearlyValue = {{ yearly_total|default:0 }};
        
        const dailyElement = document.getElementById('total-daily');
        const weeklyElement = document.getElementById('total-week');
        const monthlyElement = document.getElementById('total-month');
        const yearlyElement = document.getElementById('total-year');
        
        if (dailyElement) {
            dailyElement.textContent = dailyValue || 0;
            console.log('🔧 FORCED daily to:', dailyValue);
        }
        
        if (weeklyElement) {
            weeklyElement.textContent = weeklyValue || 0;
            console.log('🔧 FORCED weekly to:', weeklyValue);
        }
        
        if (monthlyElement) {
            monthlyElement.textContent = monthlyValue || 0;
            console.log('🔧 FORCED monthly to:', monthlyValue);
        }
        
        if (yearlyElement) {
            yearlyElement.textContent = yearlyValue || 0;
            console.log('🔧 FORCED yearly to:', yearlyValue);
        }
        
        // GLOBAL PROTECTION: Override any function that might reset these values
        const protectedValues = {
            daily: dailyValue,
            weekly: weeklyValue,
            monthly: monthlyValue,
            yearly: yearlyValue
        };
        
        // Set up mutation observer to catch any value changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'characterData' || mutation.type === 'childList') {
                    const target = mutation.target;
                    const element = target.nodeType === Node.TEXT_NODE ? target.parentElement : target;
                    
                    if (element && element.id) {
                        if (element.id === 'total-daily' && element.textContent != protectedValues.daily) {
                            console.log('🛡️ PROTECTING daily value from change:', element.textContent, '→', protectedValues.daily);
                            element.textContent = protectedValues.daily;
                        }
                        if (element.id === 'total-week' && element.textContent != protectedValues.weekly) {
                            console.log('🛡️ PROTECTING weekly value from change:', element.textContent, '→', protectedValues.weekly);
                            element.textContent = protectedValues.weekly;
                        }
                    }
                }
            });
        });
        
        // Observe changes to the card containers
        if (dailyElement) observer.observe(dailyElement, { characterData: true, childList: true, subtree: true });
        if (weeklyElement) observer.observe(weeklyElement, { characterData: true, childList: true, subtree: true });
    }
    
    // Force update now
    forceUpdateValues();
    
    // Force update with delays to catch any async operations
    setTimeout(forceUpdateValues, 500);   // After 0.5 seconds
    setTimeout(forceUpdateValues, 1500);  // After 1.5 seconds  
    setTimeout(forceUpdateValues, 3000);  // After 3 seconds
    
    console.log('🛡️ PROTECTION ACTIVE: Values will be forced at 0.5s, 1.5s, and 3s intervals');
    
    // GLOBAL PROTECTION: Override any potential chart refresh functions
    const originalRefreshCharts = window.refreshCharts;
    window.refreshCharts = function() {
        console.log('🚨 refreshCharts() intercepted - preserving production values');
        if (originalRefreshCharts && typeof originalRefreshCharts === 'function') {
            originalRefreshCharts.apply(this, arguments);
        }
        setTimeout(forceUpdateValues, 100);
        setTimeout(forceUpdateValues, 500);
        setTimeout(forceUpdateValues, 1000);
    };
    
    // Override any chart loading or data refresh functions
    const originalFetch = window.fetch;
    window.fetch = function() {
        console.log('🔍 Fetch intercepted:', arguments[0]);
        const promise = originalFetch.apply(this, arguments);
        promise.then(() => {
            setTimeout(forceUpdateValues, 100);
        });
        return promise;
    };
    
    // Force update after any refresh
    const originalSetInterval = window.setInterval;
    window.setInterval = function(func, delay) {
        if (delay === 300000) { // Our refresh interval
            return originalSetInterval(function() {
                func();
                setTimeout(forceUpdateValues, 500); // Re-force after refresh
            }, delay);
        }
        return originalSetInterval(func, delay);
    };
    
    // Device switching handled by existing green dropdown functionality
});

// Handle device change in green dropdown
function handleDeviceChange() {
    const deviceSelector = document.getElementById('deviceSelector');
    const selectedDeviceId = deviceSelector.value;
    
    console.log('🔄 Green dropdown device change:', selectedDeviceId);
    
    // Update URL parameter without reload
    const currentUrl = new URL(window.location);
    if (selectedDeviceId === 'all') {
        currentUrl.searchParams.delete('device_id');
    } else {
        currentUrl.searchParams.set('device_id', selectedDeviceId);
    }
    
    // Update URL without reloading
    history.pushState(null, '', currentUrl.toString());
    
    // Refresh charts with new device selection
    if (typeof fetchChartData === 'function') {
        fetchChartData();
    }
    
    // Update status boxes
    if (typeof updateStatusBoxes === 'function') {
        updateStatusBoxes();
    }
    
    // Update production totals for selected device (with delay to avoid conflicts)
    setTimeout(() => {
        updateProductionTotals(selectedDeviceId);
    }, 100);
    
    // Force update values if function exists (but it will skip device-specific mode)
    if (typeof forceUpdateValues === 'function') {
        setTimeout(forceUpdateValues, 500);
    }
}

// Function to update production totals based on selected device
function updateProductionTotals(deviceId) {
    if (typeof factoryId === 'undefined' || factoryId === null) {
        console.error('Factory ID is missing for production totals update');
        return;
    }
    
    console.log('🔄 Updating production totals for device:', deviceId);
    const apiUrl = `/api/production-totals/${factoryId}/?device_id=${deviceId || 'all'}`;
    console.log('📡 API URL:', apiUrl);
    
    fetch(apiUrl)
        .then(response => {
            console.log('📡 Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📡 Response data:', data);
            
            if (data.success) {
                // Update daily total
                const dailyElement = document.querySelector('[data-daily-total]');
                if (dailyElement) {
                    const formattedDaily = data.daily_total.toLocaleString();
                    dailyElement.textContent = formattedDaily;
                    console.log('✅ Updated daily total:', formattedDaily);
                } else {
                    console.warn('❌ Daily element not found');
                }
                
                // Update weekly total
                const weeklyElement = document.querySelector('[data-weekly-total]');
                if (weeklyElement) {
                    const formattedWeekly = data.weekly_total.toLocaleString();
                    weeklyElement.textContent = formattedWeekly;
                    console.log('✅ Updated weekly total:', formattedWeekly);
                } else {
                    console.warn('❌ Weekly element not found');
                }
                
                // Update monthly total
                const monthlyElement = document.querySelector('[data-monthly-total]');
                if (monthlyElement) {
                    const formattedMonthly = data.monthly_total.toLocaleString();
                    monthlyElement.textContent = formattedMonthly;
                    console.log('✅ Updated monthly total:', formattedMonthly);
                } else {
                    console.warn('❌ Monthly element not found');
                }
                
                // Update yearly total
                const yearlyElement = document.querySelector('[data-yearly-total]');
                if (yearlyElement) {
                    const formattedYearly = data.yearly_total.toLocaleString();
                    yearlyElement.textContent = formattedYearly;
                    console.log('✅ Updated yearly total:', formattedYearly);
                } else {
                    console.warn('❌ Yearly element not found');
                }
                
                console.log('✅ Production totals updated successfully for device:', deviceId);
                console.log('📊 Raw totals:', {
                    daily: data.daily_total,
                    weekly: data.weekly_total,
                    monthly: data.monthly_total,
                    yearly: data.yearly_total
                });
            } else {
                console.error('❌ API Error updating production totals:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Network Error fetching production totals:', error);
        });
}
</script>

<!-- Circular Progress Chart JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize circular progress chart
    const canvas = document.getElementById('batchProgressChart');
    if (!canvas) {
        console.warn('Batch progress chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    let progressChart = null;
    
    // Function to create/update circular progress chart
    function updateCircularProgress(progress, goal = 800) {
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 100; // Smaller radius for smaller canvas
        const lineWidth = 15; // Thinner line for smaller canvas
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Calculate progress percentage
        const percentage = Math.min((progress / goal) * 100, 100);
        const angle = (percentage / 100) * 2 * Math.PI;
        
        // Draw background circle
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#e9ecef';
        ctx.lineWidth = lineWidth;
        ctx.stroke();
        
        // Draw progress arc
        if (percentage > 0) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle);
            
            // Create gradient based on progress
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            if (percentage < 25) {
                gradient.addColorStop(0, '#dc3545'); // Red
            } else if (percentage < 50) {
                gradient.addColorStop(0, '#fd7e14'); // Orange
            } else if (percentage < 75) {
                gradient.addColorStop(0, '#ffc107'); // Yellow
            } else if (percentage < 90) {
                gradient.addColorStop(0, '#20c997'); // Teal
            } else {
                gradient.addColorStop(0, '#28a745'); // Green
            }
            
            ctx.strokeStyle = gradient;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.stroke();
        }
        
        // Update text elements
        const progressPercentageEl = document.getElementById('progressPercentage');
        const currentFlourEl = document.getElementById('currentFlour');
        const currentPercentEl = document.getElementById('currentPercent');
        const remainingFlourEl = document.getElementById('remainingFlour');
        
        if (progressPercentageEl) {
            progressPercentageEl.textContent = percentage.toFixed(1) + '%';
        }
        
        if (currentFlourEl) {
            currentFlourEl.textContent = progress.toFixed(1);
        }
        
        if (currentPercentEl) {
            currentPercentEl.textContent = percentage.toFixed(1);
        }
        
        if (remainingFlourEl) {
            const remaining = Math.max(0, goal - progress);
            remainingFlourEl.textContent = remaining.toFixed(1);
        }
        
        console.log('🔄 Circular progress updated:', {
            progress: progress,
            goal: goal,
            percentage: percentage.toFixed(1) + '%'
        });
    }
    
    // Initialize with default values
    updateCircularProgress(0, 800);
    
    // Calculate initial progress from current daily production
    const initialDailyElement = document.querySelector('[data-daily-total]');
    if (initialDailyElement) {
        const initialDailyProduction = parseFloat(initialDailyElement.textContent.replace(/,/g, ''));
        const initialDailyTons = initialDailyProduction * 0.05;
        const goal = 800;
        updateCircularProgress(initialDailyTons, goal);
        console.log('🔄 Initial circular progress calculated:', {
            dailyProduction: initialDailyProduction,
            dailyTons: initialDailyTons,
            goal: goal,
            percentage: Math.min((initialDailyTons / goal) * 100, 100).toFixed(1) + '%'
        });
    }
    
    // Make function globally available
    window.updateCircularProgress = updateCircularProgress;
    
    // Update progress when device changes (if batch data is available)
    if (typeof updateProductionTotals === 'function') {
        // Override the original function to also update circular progress
        const originalUpdateProductionTotals = updateProductionTotals;
        window.updateProductionTotals = function(deviceId) {
            originalUpdateProductionTotals(deviceId);
            
            // Update circular progress based on daily production (more realistic for batch progress)
            setTimeout(() => {
                const dailyElement = document.querySelector('[data-daily-total]');
                if (dailyElement) {
                    const dailyProduction = parseFloat(dailyElement.textContent.replace(/,/g, ''));
                    // Convert units to tons (1 unit = 50kg = 0.05 tons)
                    const dailyTons = dailyProduction * 0.05;
                    const goal = 800; // Default batch goal
                    updateCircularProgress(dailyTons, goal);
                }
            }, 200);
        };
    }
});
</script>
{% endblock %}
{% extends 'mill/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Admin Ticket Management" %} - Mill Management System{% endblock %}

{% block content %}
<div class="container-fluid my-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-ticket-alt me-2"></i>{% trans "Support Ticket Management" %}
                    </h4>
                    <div>
                        <button type="button" class="btn btn-light me-2" data-bs-toggle="modal" data-bs-target="#newTicketModal">
                            <i class="fas fa-plus me-1"></i>{% trans "New Ticket" %}
                        </button>
                        <button class="btn btn-light" onclick="refreshTickets()">
                            <i class="fas fa-sync-alt"></i>{% trans "Refresh" %}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h5>{{ total_tickets }}</h5>
                                    <small>{% trans "Total" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5>{{ new_tickets }}</h5>
                                    <small>{% trans "New" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h5>{{ in_progress_tickets }}</h5>
                                    <small>{% trans "In Progress" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-secondary text-white">
                                <div class="card-body text-center">
                                    <h5>{{ pending_tickets }}</h5>
                                    <small>{% trans "Pending" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5>{{ resolved_tickets }}</h5>
                                    <small>{% trans "Resolved" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="card bg-dark text-white">
                                <div class="card-body text-center">
                                    <h5>{{ closed_tickets }}</h5>
                                    <small>{% trans "Closed" %}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">{% trans "Filters" %}</h6>
                                </div>
                                <div class="card-body">
                                    <form method="get" class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">{% trans "Status" %}</label>
                                            <select name="status" class="form-select">
                                                <option value="">{% trans "All Statuses" %}</option>
                                                <option value="NEW" {% if status_filter == 'NEW' %}selected{% endif %}>{% trans "New" %}</option>
                                                <option value="IN_PROGRESS" {% if status_filter == 'IN_PROGRESS' %}selected{% endif %}>{% trans "In Progress" %}</option>
                                                <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>{% trans "Pending" %}</option>
                                                <option value="RESOLVED" {% if status_filter == 'RESOLVED' %}selected{% endif %}>{% trans "Resolved" %}</option>
                                                <option value="CLOSED" {% if status_filter == 'CLOSED' %}selected{% endif %}>{% trans "Closed" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">{% trans "Priority" %}</label>
                                            <select name="priority" class="form-select">
                                                <option value="">{% trans "All Priorities" %}</option>
                                                <option value="LOW" {% if priority_filter == 'LOW' %}selected{% endif %}>{% trans "Low" %}</option>
                                                <option value="MEDIUM" {% if priority_filter == 'MEDIUM' %}selected{% endif %}>{% trans "Medium" %}</option>
                                                <option value="HIGH" {% if priority_filter == 'HIGH' %}selected{% endif %}>{% trans "High" %}</option>
                                                <option value="URGENT" {% if priority_filter == 'URGENT' %}selected{% endif %}>{% trans "Urgent" %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">{% trans "Search" %}</label>
                                            <input type="text" name="search" class="form-control" 
                                                   value="{{ search_query }}" 
                                                   placeholder="{% trans 'Search by subject, name, email...' %}">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-search me-1"></i>{% trans "Filter" %}
                                                </button>
                                                <a href="{% url 'admin_tickets' %}" class="btn btn-secondary">
                                                    <i class="fas fa-times me-1"></i>{% trans "Clear" %}
                                                </a>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if tickets %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>{% trans "ID" %}</th>
                                        <th>{% trans "Subject" %}</th>
                                        <th>{% trans "From" %}</th>
                                        <th>{% trans "Type" %}</th>
                                        <th>{% trans "Priority" %}</th>
                                        <th>{% trans "Status" %}</th>
                                        <th>{% trans "Assigned To" %}</th>
                                        <th>{% trans "Created" %}</th>
                                        <th>{% trans "Last Updated" %}</th>
                                        <th>{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ticket in tickets %}
                                    <tr>
                                        <td>#{{ ticket.id }}</td>
                                        <td>
                                            <strong>{{ ticket.subject }}</strong>
                                            {% if ticket.has_unread_responses %}
                                                <span class="badge bg-danger ms-2">{% trans "New Response" %}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div>{{ ticket.name }}</div>
                                            <small class="text-muted">{{ ticket.email }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ ticket.get_ticket_type_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge {{ ticket.get_priority_display_class }}">
                                                {{ ticket.get_priority_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {{ ticket.get_status_display_class }}">
                                                {{ ticket.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if ticket.assigned_to %}
                                                {{ ticket.assigned_to.get_full_name }}
                                            {% else %}
                                                <span class="text-muted">{% trans "Unassigned" %}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ ticket.created_at|date:"M d, Y H:i" }}</td>
                                        <td>{{ ticket.updated_at|date:"M d, Y H:i" }}</td>
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" 
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-cog"></i> Actions
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="{% url 'admin_ticket_detail' ticket.id %}">
                                                            <i class="fas fa-eye me-2"></i>{% trans "View Details" %}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="quickReply({{ ticket.id }})">
                                                            <i class="fas fa-reply me-2"></i>{% trans "Quick Reply" %}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="assignTicket({{ ticket.id }})">
                                                            <i class="fas fa-user-plus me-2"></i>{% trans "Assign to User" %}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#" onclick="transferTicket({{ ticket.id }})">
                                                            <i class="fas fa-exchange-alt me-2"></i>{% trans "Transfer to Department" %}
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-success" href="#" onclick="closeTicket({{ ticket.id }})">
                                                            <i class="fas fa-check-circle me-2"></i>{% trans "Close Ticket" %}
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-warning" href="#" onclick="reopenTicket({{ ticket.id }})">
                                                            <i class="fas fa-redo me-2"></i>{% trans "Reopen Ticket" %}
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" onclick="deleteTicket({{ ticket.id }})">
                                                            <i class="fas fa-trash me-2"></i>{% trans "Delete Ticket" %}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        {% if tickets.has_other_pages %}
                        <nav aria-label="Ticket pagination">
                            <ul class="pagination justify-content-center">
                                {% if tickets.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ tickets.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{% trans "Previous" %}</a>
                                    </li>
                                {% endif %}

                                {% for num in tickets.paginator.page_range %}
                                    {% if tickets.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > tickets.number|add:'-3' and num < tickets.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if tickets.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ tickets.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{% trans "Next" %}</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{% trans "No tickets found" %}</h5>
                            <p class="text-muted">{% trans "No tickets match your current filters." %}</p>
                            <a href="{% url 'admin_tickets' %}" class="btn btn-primary">
                                <i class="fas fa-times me-1"></i>{% trans "Clear Filters" %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Ticket Modal -->
<div class="modal fade" id="newTicketModal" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 95%; width: 95%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>{% trans "Create New Ticket" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newTicketForm">
                    {% csrf_token %}
                    <!-- Top Row - Form Fields -->
                    <div class="row mb-4">
                        <!-- User Selection -->
                        <div class="col-md-5">
                            <label for="userSearch" class="form-label">{% trans "Select User" %} *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="userSearch" 
                                       placeholder="{% trans 'Type to search users...' %}" 
                                       autocomplete="off" style="min-width:0;">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()" style="min-width: 80px;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <input type="hidden" id="userSelect" name="user_id" required>
                            <div id="userSearchResults" class="list-group mt-2" style="display: none; max-height: 150px; overflow-y: auto;"></div>
                        </div>

                        <!-- Subject -->
                        <div class="col-md-3">
                            <label for="ticketSubject" class="form-label">{% trans "Subject" %} *</label>
                            <input type="text" class="form-control" id="ticketSubject" name="subject" 
                                   placeholder="{% trans 'Enter ticket subject...' %}" required>
                        </div>

                        <!-- Priority -->
                        <div class="col-md-2">
                            <label for="ticketPriority" class="form-label">{% trans "Priority" %} *</label>
                            <select class="form-select" id="ticketPriority" name="priority" required>
                                <option value="">{% trans "Select..." %}</option>
                                <option value="LOW">{% trans "Low" %}</option>
                                <option value="MEDIUM">{% trans "Medium" %}</option>
                                <option value="HIGH">{% trans "High" %}</option>
                                <option value="URGENT">{% trans "Urgent" %}</option>
                            </select>
                        </div>

                        <!-- Ticket Type -->
                        <div class="col-md-2">
                            <label for="ticketType" class="form-label">{% trans "Ticket Type" %} *</label>
                            <select class="form-select" id="ticketType" name="ticket_type" required>
                                <option value="">{% trans "Select type..." %}</option>
                                <option value="GENERAL">{% trans "General Inquiry" %}</option>
                                <option value="TECHNICAL">{% trans "Technical Support" %}</option>
                                <option value="BILLING">{% trans "Billing Question" %}</option>
                                <option value="FEATURE">{% trans "Feature Request" %}</option>
                                <option value="BUG">{% trans "Bug Report" %}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Bottom Row - Message (Full Width) -->
                    <div class="row">
                        <div class="col-12">
                            <label for="ticketMessage" class="form-label">{% trans "Message" %} *</label>
                            <textarea class="form-control" id="ticketMessage" name="message" rows="8" 
                                      placeholder="{% trans 'Enter ticket message...' %}" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="submitNewTicket()">
                    <i class="fas fa-paper-plane me-1"></i>{% trans "Verzend" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Reply Modal -->
<div class="modal fade" id="quickReplyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-reply me-2"></i>{% trans "Quick Reply" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickReplyForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="quickReplyMessage" class="form-label">{% trans "Your Response" %} *</label>
                        <textarea class="form-control" id="quickReplyMessage" name="message" rows="6" 
                                  placeholder="{% trans 'Enter your response...' %}" required></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isInternal" name="is_internal">
                            <label class="form-check-label" for="isInternal">
                                {% trans "Internal note (not visible to user)" %}
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" onclick="sendQuickReply()">
                    <i class="fas fa-paper-plane me-1"></i>{% trans "Send Response" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Ticket Modal -->
<div class="modal fade" id="assignTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>{% trans "Assign Ticket" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignTicketForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="assignToUser" class="form-label">{% trans "Assign to User" %} *</label>
                        <select class="form-select" id="assignToUser" name="assigned_to" required>
                            <option value="">{% trans "Select a user..." %}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-info" onclick="saveAssignment()">
                    <i class="fas fa-save me-1"></i>{% trans "Assign" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Ticket Modal -->
<div class="modal fade" id="transferTicketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>{% trans "Transfer Ticket" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transferTicketForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="transferDepartment" class="form-label">{% trans "Transfer to Department" %} *</label>
                        <select class="form-select" id="transferDepartment" name="department" required>
                            <option value="">{% trans "Select department..." %}</option>
                            <option value="TECHNICAL">{% trans "Technical Support" %}</option>
                            <option value="BILLING">{% trans "Billing Department" %}</option>
                            <option value="SALES">{% trans "Sales Department" %}</option>
                            <option value="GENERAL">{% trans "General Support" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transferReason" class="form-label">{% trans "Transfer Reason" %}</label>
                        <textarea class="form-control" id="transferReason" name="reason" rows="3" 
                                  placeholder="{% trans 'Explain why this ticket is being transferred...' %}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-warning" onclick="saveTransfer()">
                    <i class="fas fa-exchange-alt me-1"></i>{% trans "Transfer" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Update Modal -->
<div class="modal fade" id="quickUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Quick Update Ticket" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickUpdateForm">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Status" %}</label>
                        <select name="status" class="form-select" id="quickStatus">
                            <option value="NEW">{% trans "New" %}</option>
                            <option value="IN_PROGRESS">{% trans "In Progress" %}</option>
                            <option value="PENDING">{% trans "Pending" %}</option>
                            <option value="RESOLVED">{% trans "Resolved" %}</option>
                            <option value="CLOSED">{% trans "Closed" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Priority" %}</label>
                        <select name="priority" class="form-select" id="quickPriority">
                            <option value="LOW">{% trans "Low" %}</option>
                            <option value="MEDIUM">{% trans "Medium" %}</option>
                            <option value="HIGH">{% trans "High" %}</option>
                            <option value="URGENT">{% trans "Urgent" %}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickUpdate()">{% trans "Save Changes" %}</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTicketId = null;
let currentActionTicketId = null;

function refreshTickets() {
    location.reload();
}

// Quick Reply functionality
function quickReply(ticketId) {
    currentActionTicketId = ticketId;
    document.getElementById('quickReplyMessage').value = '';
    document.getElementById('isInternal').checked = false;
    const modal = new bootstrap.Modal(document.getElementById('quickReplyModal'));
    modal.show();
}

function sendQuickReply() {
    const message = document.getElementById('quickReplyMessage').value.trim();
    const isInternal = document.getElementById('isInternal').checked;
    
    if (!message) {
        alert('{% trans "Please enter a response message" %}');
        return;
    }
    
    const formData = new FormData();
    formData.append('message', message);
    formData.append('is_internal', isInternal);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/admin/tickets/${currentActionTicketId}/quick-reply/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickReplyModal'));
            modal.hide();
            alert('{% trans "Response sent successfully!" %}');
            location.reload();
        } else {
            alert('{% trans "Error sending response" %}: ' + (data.error || '{% trans "Unknown error" %}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error sending response" %}');
    });
}

// Assign Ticket functionality
function assignTicket(ticketId) {
    currentActionTicketId = ticketId;
    // Load available users
    fetch('/admin/tickets/search-users/?q=')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('assignToUser');
            select.innerHTML = '<option value="">{% trans "Select a user..." %}</option>';
            
            if (data.users) {
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.first_name} ${user.last_name} (${user.email})`;
                    select.appendChild(option);
                });
            }
        });
    
    const modal = new bootstrap.Modal(document.getElementById('assignTicketModal'));
    modal.show();
}

function saveAssignment() {
    const assignedTo = document.getElementById('assignToUser').value;
    
    if (!assignedTo) {
        alert('{% trans "Please select a user to assign the ticket to" %}');
        return;
    }
    
    const formData = new FormData();
    formData.append('assigned_to', assignedTo);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/admin/tickets/${currentActionTicketId}/assign/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignTicketModal'));
            modal.hide();
            alert('{% trans "Ticket assigned successfully!" %}');
            location.reload();
        } else {
            alert('{% trans "Error assigning ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error assigning ticket" %}');
    });
}

// Transfer Ticket functionality
function transferTicket(ticketId) {
    currentActionTicketId = ticketId;
    document.getElementById('transferDepartment').value = '';
    document.getElementById('transferReason').value = '';
    const modal = new bootstrap.Modal(document.getElementById('transferTicketModal'));
    modal.show();
}

function saveTransfer() {
    const department = document.getElementById('transferDepartment').value;
    const reason = document.getElementById('transferReason').value.trim();
    
    if (!department) {
        alert('{% trans "Please select a department to transfer to" %}');
        return;
    }
    
    const formData = new FormData();
    formData.append('department', department);
    formData.append('reason', reason);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/admin/tickets/${currentActionTicketId}/transfer/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('transferTicketModal'));
            modal.hide();
            alert('{% trans "Ticket transferred successfully!" %}');
            location.reload();
        } else {
            alert('{% trans "Error transferring ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error transferring ticket" %}');
    });
}

// Close Ticket functionality
function closeTicket(ticketId) {
    if (confirm('{% trans "Are you sure you want to close this ticket?" %}')) {
        const formData = new FormData();
        formData.append('status', 'CLOSED');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/admin/tickets/${ticketId}/status-update/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% trans "Ticket closed successfully!" %}');
                location.reload();
            } else {
                alert('{% trans "Error closing ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error closing ticket" %}');
        });
    }
}

// Reopen Ticket functionality
function reopenTicket(ticketId) {
    if (confirm('{% trans "Are you sure you want to reopen this ticket?" %}')) {
        const formData = new FormData();
        formData.append('status', 'NEW');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/admin/tickets/${ticketId}/status-update/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% trans "Ticket reopened successfully!" %}');
                location.reload();
            } else {
                alert('{% trans "Error reopening ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error reopening ticket" %}');
        });
    }
}

// Delete Ticket functionality
function deleteTicket(ticketId) {
    if (confirm('{% trans "Are you sure you want to delete this ticket? This action cannot be undone." %}')) {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        fetch(`/admin/tickets/${ticketId}/delete/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% trans "Ticket deleted successfully!" %}');
                location.reload();
            } else {
                alert('{% trans "Error deleting ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error deleting ticket" %}');
        });
    }
}

// User search functionality
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value;
    console.log('DEBUG: Searching for users with term:', searchTerm);
    
    if (searchTerm.length < 2) {
        alert('{% trans "Please enter at least 2 characters to search" %}');
        return;
    }
    
    console.log('DEBUG: Making fetch request to:', `/admin/tickets/search-users/?q=${encodeURIComponent(searchTerm)}`);
    
    fetch(`/admin/tickets/search-users/?q=${encodeURIComponent(searchTerm)}`)
        .then(response => {
            console.log('DEBUG: Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('DEBUG: Response data:', data);
            const resultsDiv = document.getElementById('userSearchResults');
            resultsDiv.innerHTML = '';
            
            if (data.users && data.users.length > 0) {
                console.log('DEBUG: Found', data.users.length, 'users');
                data.users.forEach(user => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${user.first_name} ${user.last_name}</strong>
                                <br><small class="text-muted">${user.email}</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="selectUser(${user.id}, '${user.first_name} ${user.last_name}', '${user.email}')">
                                {% trans "Select" %}
                            </button>
                        </div>
                    `;
                    resultsDiv.appendChild(item);
                });
                resultsDiv.style.display = 'block';
            } else {
                console.log('DEBUG: No users found');
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">{% trans "No users found" %}</div>';
                resultsDiv.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('DEBUG: Error searching users:', error);
            alert('{% trans "Error searching users" %}');
        });
}

function selectUser(userId, userName, userEmail) {
    const userSelect = document.getElementById('userSelect');
    const userSearch = document.getElementById('userSearch');
    
    // Set the hidden input value
    userSelect.value = userId;
    
    // Set the search input value to show selected user
    userSearch.value = `${userName} (${userEmail})`;
    
    // Hide results
    document.getElementById('userSearchResults').style.display = 'none';
    
    // Trigger change event to ensure the form recognizes the selection
    userSelect.dispatchEvent(new Event('change', { bubbles: true }));
    
    // Debug log
    console.log('User selected:', userId, userName, userEmail);
    console.log('Hidden input value:', userSelect.value);
}

// Submit new ticket
function submitNewTicket() {
    const form = document.getElementById('newTicketForm');
    const formData = new FormData(form);
    
    // Get form values for validation
    const userId = document.getElementById('userSelect').value;
    const subject = document.getElementById('ticketSubject').value.trim();
    const message = document.getElementById('ticketMessage').value.trim();
    const priority = document.getElementById('ticketPriority').value;
    const ticketType = document.getElementById('ticketType').value;
    
    // Debug log all values
    console.log('Form validation values:');
    console.log('userId:', userId, 'type:', typeof userId);
    console.log('subject:', subject);
    console.log('message:', message);
    console.log('priority:', priority);
    console.log('ticketType:', ticketType);
    
    // Validate required fields
    if (!userId || !subject || !message || !priority || !ticketType) {
        let missingFields = [];
        if (!userId) missingFields.push('User (please search and select a user)');
        if (!subject) missingFields.push('Subject');
        if (!message) missingFields.push('Message');
        if (!priority) missingFields.push('Priority');
        if (!ticketType) missingFields.push('Ticket Type');
        
        alert('{% trans "Please fill in all required fields" %}: ' + missingFields.join(', '));
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('#newTicketModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Sending..." %}';
    submitBtn.disabled = true;
    
    fetch('/admin/tickets/create/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(document.getElementById('newTicketModal'));
            modal.hide();
            
            // Show success message
            alert('{% trans "Ticket created successfully!" %}');
            
            // Refresh the page to show new ticket
            location.reload();
        } else {
            alert('{% trans "Error creating ticket" %}: ' + (data.error || '{% trans "Unknown error" %}'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "Error creating ticket" %}');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function quickUpdate(ticketId) {
    currentTicketId = ticketId;
    // You could fetch current ticket data here and populate the form
    $('#quickUpdateModal').modal('show');
}

function saveQuickUpdate() {
    if (!currentTicketId) return;
    
    const formData = new FormData(document.getElementById('quickUpdateForm'));
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch(`/admin/tickets/${currentTicketId}/status-update/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#quickUpdateModal').modal('hide');
            location.reload();
        } else {
            alert('Error updating ticket: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating ticket');
    });
}
</script>
{% endblock %} 
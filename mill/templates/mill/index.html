{% extends 'mill/base.html' %}
{% load static %}
{% load i18n %}
{% block title %}Control Pannel{% endblock %}

{% block content %}
<div style="position: absolute; top: 10px; left: 10px;">
    <a href="?lang=en" style="margin-right: 10px;">English</a>
    <a href="?lang=ar">Arabic</a>
</div>

<!-- Dark mode toggle -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()">
    <!-- Dark mode SVG icon -->
</div>


<!-- Filters section with user info and logout -->
<div class="filters">
    <div class="left-section">
        <div class="user-info">
            <span>{% trans 'Welcome, ' %}{{ user.username }}</span>
            <a href="{% url 'logout' %}" class="logout-button">{% trans 'Logout' %}</a>
            
            <!-- Only show Admin/Monitor dashboard link if user is a Monitor or Super Admin -->
            <a href="{% url 'admin' %}" class="admin-button">{% trans 'Admin Dashboard' %}</a>
            
            <!-- Super Admin Dashboard only for Super Admins -->
            {% if is_super_admin %}
                <a href="{% url 'super_admin:index' %}" class="super-admin-button">{% trans 'Super Admin Panel' %}</a>
            {% endif %}
            
            <a href="#" onclick="openProfilePopup()" class="profile-button">{% trans 'Profile' %}</a>
        </div>
    </div>
    <div class="form-group">
        <label for="cityDropdown">{% trans 'Select City:' %}</label>
        <select id="cityDropdown" name="cityDropdown" onchange="filterFactoriesByCity()">
            <option value="">{% trans 'Select City' %}</option>
            {% for city in cities %}
            <option value="{{ city.id }}" {% if selected_city_id == city.id %}selected{% endif %}>{{ city.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group date-picker">
        <label for="datePicker">{% trans 'Select Date:' %}</label>
        <input type="date" id="datePicker" name="date" value="{{ current_date }}" />
    </div>
</div>

<!-- Content section -->
<div class="content">
    <div class="factories-container">
        {% for factory in factories %}
        <div id="factory-{{ factory.id }}" class="factory {% if factory.status %}
					online
				{% elif not factory.error %}
					offline
				{% else %}
					error
				{% endif %} 
				{% if not factory.devices %}
					no-device
				{% endif %}" 
         data-city-id="{{ factory.city_id }}" 
         data-prev-total="0" 
         onclick="{% if factory.devices %}handleFactoryClick({{ factory.id }}, {{ factory.devices|yesno:'true,false' }}){% endif %}">
        <h2>{{ factory.name }}</h2>

        <!-- Daily Total Title -->
        <div class="totaal-vandaag-title">
            <span>{% trans "Daily Total" %}</span>
        </div>

        <!-- Display Daily Total in Bags -->
        <div class="responsive-input">
            <label for="numBags-{{ factory.id }}">{% trans "Number of Bags" %}</label>
            <span id="numBags-{{ factory.id }}" class="readonly">{{ factory.dailyTotal }}</span>
            <label for="numBags-{{ factory.id }}">{% trans "bags" %}</label>
        </div>

        <!-- Display Calculated Tons -->
        <div class="responsive-input">
            <label for="tons-{{ factory.id }}">{% trans "Quantity in Tons" %}</label>
            <span id="tons-{{ factory.id }}" class="readonly">
                {% widthratio factory.dailyTotal 20 1 as tons %}
                {{ tons|floatformat:2 }}
            </span>
            <label for="tons-{{ factory.id }}">{% trans "tons" %}</label>
        </div>

        <!-- Display Start Time -->
        <div class="responsive-input">
            <label for="startTime-{{ factory.id }}">{% trans "Start Time" %}</label>
            <span id="startTime-{{ factory.id }}" class="readonly">{{ factory.start_time|default:"N/A" }}</span>
        </div>

        <!-- Display Stop Time -->
        <div class="responsive-input">
            <label for="stopTime-{{ factory.id }}">{% trans "Stop Time" %}</label>
            <span id="stopTime-{{ factory.id }}" class="readonly">{{ factory.stop_time|default:"N/A" }}</span>
        </div>
        <div class="animation-container"></div>
    </div>
        {% endfor %}
    </div>
</div>

<!-- No devices popup -->
<div id="noDevicesPopup" class="popup">
    <h3>{% trans 'No devices found for this mill' %}</h3>
    <p>{% trans 'Please attach a device to this mill first.' %}</p>
    <button id="closePopupButton">{% trans 'OK' %}</button>
</div>

<!-- Status bar -->
<div class="status-bar" style="margin-top: auto;">
    <span>{% trans 'Daily total for all mills in this city:' %} <span id="total-daily">{{ city_daily_total }}</span></span>
    <span>{% trans 'Weekly total for all mills in this city:' %} <span id="total-week">{{ city_weekly_total }}</span></span>
    <span>{% trans 'Monthly total for all mills in this city:' %} <span id="total-month">{{ city_month_total }}</span></span>
    <span>{% trans 'Yearly total for all mills in this city (2023):' %} <span id="total-year-2023">{{ city_year_total }}</span></span>
</div>

<script src="{% static 'js/index.js' %}"></script>
{% endblock %}


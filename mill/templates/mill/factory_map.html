{% extends 'mill/base.html' %}
{% load static %}

{% block title %}{% trans "Factory Map" %}{% endblock %}

{% block content %}
<!-- Main Content -->
<div class="container-fluid my-4">
    <div class="row">
        <!-- Map Container -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marked-alt me-2"></i>Factory Locations Map
                    </h4>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-industry me-1"></i>{{ total_factories }} Factories
                        </span>
                        <span class="badge bg-success me-2">
                            <i class="fas fa-check-circle me-1"></i>{{ active_factories }} Active
                        </span>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;">
                        <div id="map-loading" style="display: flex; justify-content: center; align-items: center; height: 100%; background-color: #f8f9fa;">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading map...</span>
                                </div>
                                <p class="mt-2">Loading map...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with Factory List -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Factory List
                    </h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div id="factory-list">
                        <div class="text-center text-muted">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading factories...</span>
                            </div>
                            <p class="mt-2">Loading factories...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Factory Details Modal -->
<div class="modal fade" id="factoryModal" tabindex="-1" aria-labelledby="factoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="factoryModalLabel">Factory Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="factoryModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="viewStatsBtn">
                    <i class="fas fa-chart-bar me-1"></i>View Statistics
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Load Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.factory-item {
    transition: all 0.3s ease;
    cursor: pointer;
}

.factory-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.factory-item.active {
    background-color: #e3f2fd;
    border-color: #2196f3 !important;
}

.leaflet-popup-content {
    min-width: 200px;
}

.factory-popup {
    text-align: center;
}

.factory-popup h6 {
    margin-bottom: 10px;
    color: #333;
}

.factory-popup .status-badge {
    margin-bottom: 10px;
}

.factory-popup .production-info {
    margin-bottom: 15px;
}

.factory-popup .btn {
    width: 100%;
    margin-top: 10px;
}

#map {
    border-radius: 0 0 0.375rem 0.375rem;
}

.card-header {
    border-bottom: none;
}

.badge {
    font-size: 0.75em;
}
</style>

<script>
let map;
let markers = [];
let factoryData = JSON.parse('{{ factories|safe }}');

// Initialize map
function initMap() {
    // Hide loading indicator
    const loadingDiv = document.getElementById('map-loading');
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
    
    // Default center (Iraq)
    const defaultCenter = [33.2232, 43.6793];
    
    map = L.map('map').setView(defaultCenter, 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Add markers for each factory
    factoryData.forEach(factory => {
        addFactoryMarker(factory);
    });
}

// Add factory marker to map
function addFactoryMarker(factory) {
    const markerColor = factory.status ? '#28a745' : '#dc3545';
    const icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    const marker = L.marker([factory.latitude, factory.longitude], { icon: icon })
        .addTo(map)
        .bindPopup(createPopupContent(factory))
        .on('click', function() {
            showFactoryDetails(factory);
        });
    
    markers.push(marker);
}

// Create popup content for factory
function createPopupContent(factory) {
    return `
        <div class="factory-popup">
            <h6>${factory.name}</h6>
            <div class="status-badge">
                <span class="badge ${factory.status ? 'bg-success' : 'bg-danger'}">
                    ${factory.status ? 'Active' : 'Inactive'}
                </span>
            </div>
            <div class="production-info">
                <strong>Daily Production:</strong><br>
                ${factory.daily_production.toLocaleString()} units
            </div>
            <div class="device-info">
                <small>${factory.active_devices}/${factory.total_devices} devices active</small>
            </div>
            <button class="btn btn-sm btn-primary" onclick="showFactoryDetails(${JSON.stringify(factory).replace(/"/g, '&quot;')})">
                View Details
            </button>
        </div>
    `;
}

// Show factory details in modal
function showFactoryDetails(factory) {
    const modalBody = document.getElementById('factoryModalBody');
    const viewStatsBtn = document.getElementById('viewStatsBtn');
    
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Factory Information</h6>
                <p><strong>Name:</strong> ${factory.name}</p>
                <p><strong>City:</strong> ${factory.city}</p>
                <p><strong>Address:</strong> ${factory.address}</p>
                <p><strong>Status:</strong> 
                    <span class="badge ${factory.status ? 'bg-success' : 'bg-danger'}">
                        ${factory.status ? 'Active' : 'Inactive'}
                    </span>
                </p>
            </div>
            <div class="col-md-6">
                <h6>Production Data</h6>
                <p><strong>Daily Production:</strong> ${factory.daily_production.toLocaleString()} units</p>
                <p><strong>Active Devices:</strong> ${factory.active_devices}/${factory.total_devices}</p>
                <p><strong>Coordinates:</strong> ${factory.latitude}, ${factory.longitude}</p>
            </div>
        </div>
    `;
    
    viewStatsBtn.href = `/view-statistics/${factory.id}/`;
    
    const modal = new bootstrap.Modal(document.getElementById('factoryModal'));
    modal.show();
}

// Center map on specific factory
function centerOnFactory(lat, lng) {
    map.setView([lat, lng], 12);
}

// Refresh map data
function refreshMap() {
    fetch('{% url "factory_map_data" %}')
        .then(response => response.json())
        .then(data => {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Update factory data
            factoryData = data.factories;
            
            // Add new markers
            factoryData.forEach(factory => {
                addFactoryMarker(factory);
            });
            
            // Update factory list
            updateFactoryList();
        })
        .catch(error => {
            console.error('Error refreshing map:', error);
        });
}

// Update factory list
function updateFactoryList() {
    const factoryList = document.getElementById('factory-list');
    
    if (factoryData.length === 0) {
        factoryList.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                <p>No factories with coordinates found.</p>
                <p class="small">Add coordinates to factories in the admin panel.</p>
            </div>
        `;
        return;
    }
    
    factoryList.innerHTML = factoryData.map(factory => `
        <div class="factory-item mb-3 p-3 border rounded" 
             data-factory-id="${factory.id}"
             data-lat="${factory.latitude}"
             data-lng="${factory.longitude}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="mb-1">${factory.name}</h6>
                    <small class="text-muted">${factory.city}</small>
                    <div class="mt-2">
                        <span class="badge ${factory.status ? 'bg-success' : 'bg-danger'} me-2">
                            ${factory.status ? 'Active' : 'Inactive'}
                        </span>
                        <span class="badge bg-info">
                            ${factory.active_devices}/${factory.total_devices} Devices
                        </span>
                    </div>
                    <div class="mt-2">
                        <strong>Daily Production:</strong> ${factory.daily_production.toLocaleString()} units
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="centerOnFactory(${factory.latitude}, ${factory.longitude})">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
            <div class="mt-2">
                <a href="/view-statistics/${factory.id}/" 
                   class="btn btn-sm btn-primary w-100">
                    <i class="fas fa-chart-bar me-1"></i>View Statistics
                </a>
            </div>
        </div>
    `).join('');
}

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing map...');
    console.log('Factory data:', factoryData);
    console.log('Leaflet available:', typeof L !== 'undefined');
    
    try {
        initMap();
        console.log('Map initialized successfully');
        
        // Update factory list after map is initialized
        updateFactoryList();
    } catch (error) {
        console.error('Error initializing map:', error);
    }
    
    // Add click handlers to factory list items
    document.addEventListener('click', function(e) {
        if (e.target.closest('.factory-item')) {
            const factoryItem = e.target.closest('.factory-item');
            const factoryId = factoryItem.dataset.factoryId;
            const factory = factoryData.find(f => f.id == factoryId);
            
            if (factory) {
                centerOnFactory(factory.latitude, factory.longitude);
                showFactoryDetails(factory);
            }
        }
    });
});
</script>
{% endblock %} 